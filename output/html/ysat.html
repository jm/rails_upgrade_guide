<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC
    "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN"
    "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xmlns:svg='http://www.w3.org/2000/svg' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
<head><meta content='application/xhtml+xml;charset=utf-8' http-equiv='Content-type' /><title>The Rails Upgrade Handbook</title><link href='style.css' rel='stylesheet' type='text/css' />
</head>
<body>
<p>blah</p>

<h6 id='blah'>Blah</h6>

<p>blah</p>

<h1 id='rails_upgrade_handbook'>Rails Upgrade Handbook</h1>
<div class='maruku_toc'><ul style='list-style: none;'><li><span class='maruku_section_number'>1. </span><a href='#purchase_the_whole_book'>Purchase the whole book!</a></li><li><span class='maruku_section_number'>2. </span><a href='#introduction'>Introduction</a><ul style='list-style: none;'><li><span class='maruku_section_number'>2.1. </span><a href='#the_big_picture'>The Big Picture</a><ul style='list-style: none;'><li><span class='maruku_section_number'>2.1.1. </span><a href='#lifecycle_changes'>Lifecycle changes</a></li><li><span class='maruku_section_number'>2.1.2. </span><a href='#making_controllers_flexible'>Making controllers flexible</a></li><li><span class='maruku_section_number'>2.1.3. </span><a href='#where_models_are_concerned'>Where models are concerned</a></li><li><span class='maruku_section_number'>2.1.4. </span><a href='#other_pieces'>Other pieces</a></li></ul></li><li><span class='maruku_section_number'>2.2. </span><a href='#thats_greatbut_why_bother'>That&#8217;s great&#8230;but why bother?</a><ul style='list-style: none;'><li><span class='maruku_section_number'>2.2.1. </span><a href='#performance'>Performance</a></li><li><span class='maruku_section_number'>2.2.2. </span><a href='#new_features'>New features</a></li><li><span class='maruku_section_number'>2.2.3. </span><a href='#easier_segmentation'>Easier segmentation</a></li></ul></li></ul></li><li><span class='maruku_section_number'>3. </span><a href='#essentials'>Essentials</a><ul style='list-style: none;'><li><span class='maruku_section_number'>3.1. </span><a href='#preliminary_steps'>Preliminary steps</a><ul style='list-style: none;'><li><span class='maruku_section_number'>3.1.1. </span><a href='#getting_the_right_ruby'>Getting the right Ruby</a><ul style='list-style: none;'><li><span class='maruku_section_number'>3.1.1.1. </span><a href='#mac_os_x_or_other_unix_platforms'>Mac OS X or other Unix platforms</a></li><li><span class='maruku_section_number'>3.1.1.2. </span><a href='#windows'>Windows</a></li></ul></li><li><span class='maruku_section_number'>3.1.2. </span><a href='#installing_rails_3'>Installing Rails 3</a></li></ul></li><li><span class='maruku_section_number'>3.2. </span><a href='#automating_some_of_the_upgrade_'>Automating some of the upgrade: <code style='background-color: #dddddd;'>rails_upgrade</code></a><ul style='list-style: none;'><li><span class='maruku_section_number'>3.2.1. </span><a href='#_find_out_what_needs_to_be_upgraded'><code style='background-color: #dddddd;'>rails:upgrade:check</code>: Find out what needs to be upgraded</a></li><li><span class='maruku_section_number'>3.2.2. </span><a href='#_upgrading_routes'><code style='background-color: #dddddd;'>rails:upgrade:routes</code>: Upgrading routes</a></li><li><span class='maruku_section_number'>3.2.3. </span><a href='#_creating_gemfiles'><code style='background-color: #dddddd;'>rails:upgrade:gems</code>: Creating Gemfiles</a></li><li><span class='maruku_section_number'>3.2.4. </span><a href='#_backing_up_important_files'><code style='background-color: #dddddd;'>rails:upgrade:backup</code>: Backing up important files</a></li><li><span class='maruku_section_number'>3.2.5. </span><a href='#_generating_your_new_configuration_files'><code style='background-color: #dddddd;'>rails:upgrade:configuration</code>: Generating your new configuration files</a></li></ul></li><li><span class='maruku_section_number'>3.3. </span><a href='#starting_an_upgrade_with_the_plugin'>Starting an upgrade with the plugin</a><ul style='list-style: none;'><li><span class='maruku_section_number'>3.3.1. </span><a href='#run_the_application_checks'>Run the application checks</a></li><li><span class='maruku_section_number'>3.3.2. </span><a href='#back_up_important_files'>Back up important files</a></li></ul></li><li><span class='maruku_section_number'>3.4. </span><a href='#regenerate_the_application'>Regenerate the application</a></li></ul></li><li><span class='maruku_section_number'>4. </span><a href='#getting_bootable'>Getting bootable</a><ul style='list-style: none;'><li><span class='maruku_section_number'>4.1. </span><a href='#configuring_your_app_again'>Configuring your app again</a></li><li><span class='maruku_section_number'>4.2. </span><a href='#configuring_the_environment'>Configuring the environment</a><ul style='list-style: none;'><li><span class='maruku_section_number'>4.2.1. </span><a href='#converting_your_routes_file'>Converting your routes file</a></li><li><span class='maruku_section_number'>4.2.2. </span><a href='#setting_up_the_gem_bundler'>Setting up the gem bundler</a></li></ul></li><li><span class='maruku_section_number'>4.3. </span><a href='#code_fixes'>Code fixes</a><ul style='list-style: none;'><li><span class='maruku_section_number'>4.3.1. </span><a href='#_constants_are_deprecated'><code style='background-color: #dddddd;'>RAILS_*</code> constants are deprecated</a></li><li><span class='maruku_section_number'>4.3.2. </span><a href='#converting_mailers_to_the_new_api'>Converting mailers to the new API</a></li><li><span class='maruku_section_number'>4.3.3. </span><a href='#new_active_record_api'>New Active Record API</a></li></ul></li><li><span class='maruku_section_number'>4.4. </span><a href='#minor_prebooting_issues'>Minor pre-booting issues</a><ul style='list-style: none;'><li><span class='maruku_section_number'>4.4.1. </span><a href='#delete_'>Delete <code style='background-color: #dddddd;'>new_rails_defaults.rb</code></a></li><li><span class='maruku_section_number'>4.4.2. </span><a href='#rack_configuration_is_required'>Rack configuration is required</a></li></ul></li><li><span class='maruku_section_number'>4.5. </span><a href='#booting_the_application'>Booting the application</a></li><li><span class='maruku_section_number'>4.6. </span><a href='#its_booted_now_what'>It&#8217;s booted! Now what&#8230;?</a><ul style='list-style: none;'><li><span class='maruku_section_number'>4.6.1. </span><a href='#check_out_your_views'>Check out your views</a></li><li><span class='maruku_section_number'>4.6.2. </span><a href='#deprecations_coming_soon'>Deprecations coming soon</a></li></ul></li></ul></li><li><span class='maruku_section_number'>5. </span><a href='#improving_your_application_with_rails_3'>Improving your application with Rails 3</a><ul style='list-style: none;'><li><span class='maruku_section_number'>5.1. </span><a href='#cleaning_up_controllers'>Cleaning up controllers</a><ul style='list-style: none;'><li><span class='maruku_section_number'>5.1.1. </span><a href='#responders'>Responders</a></li><li><span class='maruku_section_number'>5.1.2. </span><a href='#cleaner_flash_messages'>Cleaner flash messages</a></li></ul></li><li><span class='maruku_section_number'>5.2. </span><a href='#creating_improved_views'>Creating improved views</a><ul style='list-style: none;'><li><span class='maruku_section_number'>5.2.1. </span><a href='#making_your_views_safer'>Making your views safer</a></li><li><span class='maruku_section_number'>5.2.2. </span><a href='#better_javascript_with_rails_3'>Better JavaScript with Rails 3</a></li></ul></li><li><span class='maruku_section_number'>5.3. </span><a href='#building_better_routes'>Building better routes</a><ul style='list-style: none;'><li><span class='maruku_section_number'>5.3.1. </span><a href='#routing_to_rack_applications'>Routing to Rack applications</a></li></ul></li><li><span class='maruku_section_number'>5.4. </span><a href='#improving_your_model_logic'>Improving your model logic</a><ul style='list-style: none;'><li><span class='maruku_section_number'>5.4.1. </span><a href='#better_query_composition'>Better query composition</a></li><li><span class='maruku_section_number'>5.4.2. </span><a href='#cleaning_up_your_validations'>Cleaning up your validations</a></li></ul></li><li><span class='maruku_section_number'>5.5. </span><a href='#building_better_data_classes'>Building better data classes</a></li></ul></li><li><span class='maruku_section_number'>6. </span><a href='#case_studies'>Case Studies</a><ul style='list-style: none;'><li><span class='maruku_section_number'>6.1. </span><a href='#application_case_study_jamis_bucks_bucketwise'>Application Case Study: Jamis Buck&#8217;s Bucketwise</a></li><li><span class='maruku_section_number'>6.2. </span><a href='#plugin_case_study_'>Plugin Case Study: <code style='background-color: #dddddd;'>restful_authentication</code></a></li><li><span class='maruku_section_number'>6.3. </span><a href='#plugin_case_study'>Plugin Case Study:</a></li><li><span class='maruku_section_number'>6.4. </span><a href='#lessons_learned'>Lessons learned</a></li></ul></li><li><span class='maruku_section_number'>7. </span><a href='#checksheet_the_upgrade_process'>Checksheet: The Upgrade Process</a><ul style='list-style: none;'><li><span class='maruku_section_number'>7.1. </span><a href='#first_steps'>First Steps</a></li><li><span class='maruku_section_number'>7.2. </span><a href='#reconfiguration'>Reconfiguration</a></li><li><span class='maruku_section_number'>7.3. </span><a href='#fix_code'>Fix code</a></li><li><span class='maruku_section_number'>7.4. </span><a href='#booting'>Booting</a></li></ul></li><li><span class='maruku_section_number'>8. </span><a href='#checksheet_deprecations'>Checksheet: Deprecations</a><ul style='list-style: none;'><li><span class='maruku_section_number'>8.1. </span><a href='#generalconfiguration'>General/configuration</a></li><li><span class='maruku_section_number'>8.2. </span><a href='#plugins'>Plugins</a></li><li><span class='maruku_section_number'>8.3. </span><a href='#controllersdispatch'>Controllers/dispatch</a></li><li><span class='maruku_section_number'>8.4. </span><a href='#models'>Models</a></li><li><span class='maruku_section_number'>8.5. </span><a href='#views'>Views</a></li><li><span class='maruku_section_number'>8.6. </span><a href='#testing'>Testing</a></li><li><span class='maruku_section_number'>8.7. </span><a href='#mailers'>Mailers</a></li></ul></li></ul></div>
<h2 id='purchase_the_whole_book'><span class='maruku_section_number'>1. </span>Purchase the whole book!</h2>

<p>Buy the whole book for <strong>$20</strong> and get&#8230;</p>

<ul>
<li>Over 100 pages of upgrade information</li>

<li>A step-by-step guide to upgrading your app to Rails 3</li>

<li>High-level discussion of what&#8217;s new in Rails 3</li>

<li>Practical tips on using Rails 3&#8217;s new features to improve your code</li>

<li>Real case studies of upgrading apps and plugins</li>

<li>Detailed checklists for upgrading</li>
</ul>

<p>Head over to <a href='http://railsupgradehandbook.com/'>http://railsupgradehandbook.com/</a> for more information and purchasing!</p>

<h2 id='introduction'><span class='maruku_section_number'>2. </span>Introduction</h2>

<p>Rails debuted in late 2004 and changed the way a lot of people think about web development. Today in early 2010, we&#8217;re looking at a totally new, more mature framework in Rails 3.0 that (I believe) will change the way a lot of Rails developers think about how they use it. The new features, performance improvements, and API changes aren&#8217;t incredibly drastic, but they do present great opportunities (and challenges) to those looking to upgrade existing code to the newest version. This e-book is a look at how to go about upgrading your existing Rails app to Rails 3, how to convert common patterns to new ones, and how to improve your existing code in light of the new Rails 3 features. First, though, we should go over some of the high-level philosophical and architectural changes that have gone on in the Rails code between versions 2 and 3.</p>

<h3 id='the_big_picture'><span class='maruku_section_number'>2.1. </span>The Big Picture</h3>

<p>When the Merb/Rails merge was announced, some members of the Rails community were very interested to see how the final product ended up: was it going to be more of the same, something totally new, or simply Merb 2.0? But as we&#8217;re approaching a final product, we&#8217;re finding out that we&#8217;re getting the best of both worlds: the ease of use and packaging of Rails with the juicy technical bits of Merb. Who can argue with that?</p>

<p>As the team worked together towards a vision for the project, obviously changes were made to the Rails way of doing things. These big picture changes have concentrated on a few key areas:</p>

<ul>
<li>Decoupling Rails components from one another as much as possible, making things more modular and a la carte.<em class='fn'>http://yehudakatz.com/2009/07/19/rails-3-the-great-decoupling/</em></li>

<li>Pulling in improvements from Merb and rewrite/refactor much of the internals to improve performance.<em class='fn'>http://www.engineyard.com/blog/2009/rails-and-merb-merge-performance-part-2-of-6/</em></li>

<li>Exposing explicit, documented API&#8217;s for common tasks and integration of wider ecosystem components from testing, ORM, etc.</li>
</ul>

<p>In order to hit these objectives, DHH, Yehuda, Josh, and the rest of the Rails team have extracted things into some new components, expanded others, and removed others to allow for agnostic integration points for things like the ORM and testing framework.</p>

<p class='img'><img src='ecosystem.png' alt='Overview' /></p>

<p>The general movement seems to be from a monolithic, one-stop shop approach to a looser ecosystem of code that works together with a straightforward set of sensible defaults. You&#8217;re no longer &#8220;locked in&#8221; to Active Record or made to use code injection and hacks and such to get your testing framework integrated. Instead, there are hooks all over the place to cover this sort of integration that let generators generate components for the various options or helpers include different modules. It&#8217;s a great way to support the existing plugin and tool ecosystem, except this time with an established API.</p>

<h4 id='lifecycle_changes'><span class='maruku_section_number'>2.1.1. </span>Lifecycle changes</h4>

<p>One of the biggest movements in the codebase has been a shift towards using simple, composed components and a lot of Rack features in the request chain rather than specialized, one-off classes. This has affected a lot of things, but one of the major changes has been the addition of <em>Action Dispatch</em>.<em class='fn'>http://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch.rb</em></p>

<p class='img'><img src='lifecycle.png' alt='The request chain' /></p>

<p>Action Dispatch is a &#8220;new&#8221; component in Action Pack (extracted and expanded from the previous logic) that handles a number of things related to requests and responses:</p>

<ul>
<li>Request handling and parameter parsing</li>

<li>Sessions, Rails&#8217; flash, and cookie storage</li>

<li>File uploads</li>

<li>Routing, URL matching, and rescuing errors</li>

<li>HTTP conditional GETs</li>

<li>Client response and HTTP status code</li>
</ul>

<p>Breaking this functionality out into its own component and decoupling much of it creates a much more flexible call stack for requests, meaning you can jack into the process easier with your own logic or improve the existing functionality. I&#8217;m sure we&#8217;ll see a lot of plugins taking advantage of this to create interesting middleware hacks, improve callbacks and lifecycle methods, hack in their own middlewares to handle specialized logic, or even plug in improved or application-specific routers.</p>

<h4 id='making_controllers_flexible'><span class='maruku_section_number'>2.1.2. </span>Making controllers flexible</h4>

<p>As a result of the changes in the request chain, the controller stack has also seen a significant overhaul. Previously, every controller inherited from <code style='background-color: #dddddd;'>ActionController::Base</code> (either directly or by inheriting from <code style='background-color: #dddddd;'>ApplicationController</code>), and to slim down the call stack, one had to either (a) previous to Rails 2.3, building a smaller app with Sinatra or Rack to sit next to your main Rails application or (b) post-Rails 2.3, using Rails Metal/Rack middlewares.</p>

<p>In Rails 3.0, this concept of middleware plays an even more central role to how the controller hierarchy is arranged.</p>

<p class='img'><img src='stack.png' alt='The new controller stack' /></p>

<p>The bottom of the stack is <code style='background-color: #dddddd;'>AbstractController</code>, a very low level &#8220;controller.&#8221; Rails uses this class to abstract away essentials like rendering, layouts, managing template paths, and so on, while leaving more concrete implementation details to its subclasses. <code style='background-color: #dddddd;'>AbstractController</code> exists only to provide these facilities to subclasses. That is, you should not use this class directly; if you want something super-slim, create a subclass and implement <code style='background-color: #dddddd;'>render</code> and a few other pieces).</p>

<p>Each subsequent jump up the hierarchy is actually a class that inherits from the previous, each including modules to compose its behavior. So, if you want to create something slim without implementing a lot of plumbing, use the next rung on the compositional ladder: <code style='background-color: #dddddd;'>ActionController::Metal</code>. <code style='background-color: #dddddd;'>Metal</code> essentially exposes super simple Rack endpoints that you can then include extra modules into to add more <code style='background-color: #dddddd;'>ActionController</code> functionality. These little classes are excellent for replacing those Rack/Sinatra apps for file uploads or what have you while still having the power to easily build out to rather rich controller objects.</p>

<p>Finally, if you need the full monty (i.e., like a controller in Rails 2), then you&#8217;ll need to inherit from <code style='background-color: #dddddd;'>ActionController::Base</code>. This class inherits from <code style='background-color: #dddddd;'>ActionController::Metal</code> and includes a slew of modules to handle things like redirecting the user, handling implicit rendering, and a number of helpers for other stuff like caching.</p>

<p>The advantage of taking this approach is that you can take one of the base classes like <code style='background-color: #dddddd;'>Metal</code> and include your own modules to create specialized controllers. I foresee someone using this to create a simple way to serve up resources (e.g., <code style='background-color: #dddddd;'>PostsController &lt; ResourcesController(:posts)</code> or something like that) much like people have done previously or using it as a way to quickly build API backends. This is the other piece of the major refactor that excites me, since we&#8217;re looking at a new way to construct reusable code and assemble it into usable applications.</p>

<h4 id='where_models_are_concerned'><span class='maruku_section_number'>2.1.3. </span>Where models are concerned</h4>

<p>Though the public API for models is generally the same (with a few additions and changes that I&#8217;ll cover in a subsequent post), Active Record is now powered by the brain-melting Active Relation, a powerful relational algebra layer.</p>

<p class='img'><img src='arel.png' alt='Intelligent SQL generation' /></p>

<p>What does that mean for you? Well, basically it means that Active Record will be smarter and more powerful. Rather than fairly na√Øve SQL generation, it uses some fancy mathemagical approach that should generate smarter queries. Frankly, I haven&#8217;t had a lot of time to research these features for myself, but when I do, I&#8217;ll be sure to post (or if you&#8217;ve posted about this stuff somewhere, then by all means let me know).</p>

<p>The second big change in Model Land is the extraction of much of the rich logic in Active Record objects like callbacks, validations, serialization, and so on into the Active Model module.</p>

<p class='img'><img src='amo.png' alt='ActiveModel' /></p>

<p>You can use this module to make any object behave like an Active Record object; for example, let&#8217;s say you wanted to add some validations to a PORO representing a host on a network:</p>

<pre style='background-color: #dddddd;'><code>class Host
  include ActiveModel::Validations

  validates_presence_of :hostname

  attr_accessor :ip_address, :hostname, :operating_system
  def initialize(hostname, ip_address, operating_system)
    @hostname, @ip_address, @operating_system = host, ip_address, operating_system
  end
end

h  = Host.new(&quot;skull&quot;, &quot;24.44.129.10&quot;, &quot;Linux&quot;)
h.valid?    # =&gt; true
h.hostname = nil
h.valid?    # =&gt; false</code></pre>

<p>To get this functionality, simply include <code style='background-color: #dddddd;'>ActiveModel::Validations</code> and start implementing the methods. It&#8217;s possible to exercise fine-grained control over how the validations operate, how the validator gets the object&#8217;s attributes, and so on. To get the other functionality like observing or callbacks, just include the relevant module (e.g., <code style='background-color: #dddddd;'>ActiveModel::Observing</code>) and implement the required methods. It&#8217;s fantastically clever.</p>

<h4 id='other_pieces'><span class='maruku_section_number'>2.1.4. </span>Other pieces</h4>

<p>ActionMailer is also getting some love in Rails 3, and the new API is looking especially delicious. Mailer classes are much more like a controller with some excellent helpers mixed in just for mailing rather than some weird mashup of a model and a controller.</p>

<pre style='background-color: #dddddd;'><code>Awesome example goes here.</code></pre>

<p>No more magic <code style='background-color: #dddddd;'>deliver_*</code> methods, no more weird half-DSL methods for setting things up for the e-mail, and no more wishing we had the power of controllers in mailers.</p>

<p>Rails is also getting a rather robust instrumentation framework. In essence, an instrumentation framework lets you subscribe to events inside of a system and respond to them in meaningful ways (e.g., an action renders and the logger logs its result). Internally the framework is used for things like logging and debugging, but you could easily repurpose the code for other things. For example, let&#8217;s say you want to log to the system logger when a particular e-mail is sent out:</p>

<pre style='background-color: #dddddd;'><code># Subscribe to the event...
ActiveSupport::Notifications.subscribe do |*args|
  @events &lt;&lt; ActiveSupport::Notifications::Event.new(*args)
end

# Fire the event...
ActiveSupport::Notifications.instrument(:system_mail, :at =&gt; Time.now) do
  #SystemMailer.important_email.deliver
  log &quot;Important system mail sent!&quot;
end

# Do something with it...
event = @events.first
event.name        # =&gt; :system_mail
event.payload     # =&gt; { :at =&gt; Wed Jan 16 00:51:14 -0600 2010 }
event.duration    # =&gt; 0.063
system_log(event) # =&gt; &lt;whatever&gt;</code></pre>

<p>Of course, this is arbitrary, but it adds a really powerful way to respond to certain events in your application.</p>

<pre style='background-color: #dddddd;'><code>Practical example with sql stuff here</code></pre>

<p>For example, someone could probably rewrite the <code style='background-color: #dddddd;'>exception_notification</code> plugin<em class='fn'>http://github.com/rails/exception_notification</em> to use the instrumentation framework to handle and send error e-mails.</p>

<h3 id='thats_greatbut_why_bother'><span class='maruku_section_number'>2.2. </span>That&#8217;s great&#8230;but why bother?</h3>

<p>With so much Rails 2.x code floating about, developers will need more compelling reasons than &#8220;it&#8217;s new and shiny&#8221; to upgrade their applications to Rails 3. Of course, the obvious benefit of keeping up to date with the newest bugfixes and security patches is important, but there are larger reasons that developers should consider the move.</p>

<h4 id='performance'><span class='maruku_section_number'>2.2.1. </span>Performance</h4>

<p>Yehuda has remarked numerous times that one of his prime objectives in doing a lot of the refactoring has been to improve performance. We won&#8217;t see final numbers for some time (just as we won&#8217;t see a final Rails release for a little while), but the general code simplification has added significantly to the performance of even the most menial of apps.</p>

<p>Much of the refactoring of the Rails internals has endeavored to reduce the request call stack so that there is less code between a request entering the application and sending data to the client. There has also been significant attention given to previously slow components such as partial rendering and URL generation. While many of these optimizations reduce the total request time by minuscule amounts (on the order of microseconds), many of these small increases in speed paired with a few that add significant speed make the overall speed increase fairly significant.<em class='fn'>http://www.engineyard.com/blog/2009/rails-and-merb-merge-performance-part-2-of-6/</em></p>

<h4 id='new_features'><span class='maruku_section_number'>2.2.2. </span>New features</h4>

<p>Many of the newly added features are not only &#8220;new and shiny&#8221;, they could also greatly aid in cleaning up or actively improving your current codebase. The new routing DSL helps tame unruly routes files, and the new Active Record API can help in areas where programmatic composition of queries is necessary (e.g., building faceted filters). The new <code style='background-color: #dddddd;'>Responder</code> cleans up and abstracts much of the common logic in RESTful controllers; Active Model can replace many of the hacks and extra libraries that developers use for object validation and relation. Not to mention the minor conveniences like automatic output escaping and XSS protection. In short, the new features add a lot of power to the framework and give you the ability to reduce your code maintenance.</p>

<p>It&#8217;s easy to say that you can continue on without these features, but it might serve you well to figure out how many hours (and in turn, how much money) you&#8217;re wasting maintaining that gnarly routes file or debugging and updating those data class validation methods? How sure are you that your app&#8217;s output is totally covered with XSS protection? The attraction of new features in terms of upgrading from one version of a tool to another isn&#8217;t always simply &#8220;oh that&#8217;s new and I want to play with it&#8221;; often times the attraction is the new power and freedom afforded to developers.</p>

<h4 id='easier_segmentation'><span class='maruku_section_number'>2.2.3. </span>Easier segmentation</h4>

<p>Lastly, segmenting a big app into smaller mountable apps has never been easier. With the addition of Rails Metal in Rails 2.3 developers were given a taste of deep Rack integration with Rails, but in Rails 3, Rack is a first-class citizen. As mentioned previously, Rack is now an integral part of the Rails request stack making it a cinch use it in a much more meaningful way.</p>

<p>No longer do you have to maintain that separate Merb or Sinatra application just for that simple, one-off task; now you can integrate that directly with your Rails app. Doing so will reduce your codebase dissonance since everything is in Rails, cut down on integration issues, and, very likely, reduce the amount of hardware you&#8217;ll need sitting under your application.</p>

<p>Now that we&#8217;ve taken a mile-high view of the changes and the upgrade landscape, let&#8217;s dig in a little bit further.</p>

<h2 id='essentials'><span class='maruku_section_number'>3. </span>Essentials</h2>

<p>In this section we&#8217;ll look at installing the necessary components for Rails 3 and how to take the first steps toward upgrading your application.</p>

<h3 id='preliminary_steps'><span class='maruku_section_number'>3.1. </span>Preliminary steps</h3>

<p>The requirements for Rails 3 are a bit more demanding that Rails 2.x in the sense that you must install newer, less common versions of many of the tools that you use everyday.</p>

<h4 id='getting_the_right_ruby'><span class='maruku_section_number'>3.1.1. </span>Getting the right Ruby</h4>

<p>Rails 3 requires at least Ruby 1.8.7 or a 1.9.2 or later series of Ruby 1.9 (1.9.1 will probably work, but it is not supported due to some major bugs). Getting one of these installed is pretty easy on most platforms.</p>

<h5 id='mac_os_x_or_other_unix_platforms'><span class='maruku_section_number'>3.1.1.1. </span>Mac OS X or other Unix platforms</h5>

<p>If you&#8217;re on a Mac or other Unix platform, I highly recommend that you use <code style='background-color: #dddddd;'>rvm</code> to manage your Ruby installations. It leaves your system Ruby untouched and lets you effortlessly switch among different versions. To do so, it manipulates your shell path using <code style='background-color: #dddddd;'>bash</code> or <code style='background-color: #dddddd;'>zsh</code> scripts; that means if you use another shell like <code style='background-color: #dddddd;'>fish</code> or <code style='background-color: #dddddd;'>csh</code>, then you&#8217;re out of luck and will have to find another option. If you <em>are</em> a <code style='background-color: #dddddd;'>bash</code> or <code style='background-color: #dddddd;'>zsh</code> user, though, then you can install install <code style='background-color: #dddddd;'>rvm</code> by simply installing the gem:</p>

<pre style='background-color: #dddddd;'><code>gem install rvm</code></pre>

<p>Next, run the installation script:</p>

<pre style='background-color: #dddddd;'><code>rvm-install</code></pre>

<p>Then, if using <code style='background-color: #dddddd;'>bash</code>, it needs to be added to your profile. You can use this little script taken from the <code style='background-color: #dddddd;'>rvm</code> documentation to do that:</p>

<pre style='background-color: #dddddd;'><code>for profile in .bash_profile .bashrc
  do echo &#39;if [[ -s &quot;$HOME/.rvm/scripts/rvm&quot; ]]
  then source &quot;$HOME/.rvm/scripts/rvm&quot; 
fi&#39; &gt;&gt; ~/.$profile fi
source ~/.rvm/scripts/rvm</code></pre>

<p>And that&#8217;s that. To install another Ruby version (like 1.8.7), then you simply run <code style='background-color: #dddddd;'>rvm install 1.8.7</code> then <code style='background-color: #dddddd;'>rvm use 1.8.7</code>. You can get a list of what Ruby versions you have installed with <code style='background-color: #dddddd;'>rvm list</code> or switch back to your system setup using <code style='background-color: #dddddd;'>rvm use system</code>.</p>

<p>If you aren&#8217;t using <code style='background-color: #dddddd;'>bash</code> or <code style='background-color: #dddddd;'>zsh</code>, or would simply prefer to only have one version of Ruby running, you can likely install Ruby from your package manager. On Linux, your distribution probably has at least a 1.8.7 build available, and MacPorts has both 1.8.7 and a 1.9 build available. If none of these options suits you, then you can always of course build from source, but that&#8217;s <em>so</em> 1997.</p>

<h5 id='windows'><span class='maruku_section_number'>3.1.1.2. </span>Windows</h5>

<p>If you&#8217;re on Windows and value your sanity, you&#8217;ll probably want to stick to one of the precompiled stacks; attempting to compile Ruby on Windows can be an exercise in frustration. Ruby core provides basic binaries, but they require a lot of extra libraries and steps to get them working. Fortunately, there are a lot of great pre-compiled, one-stop options for Windows users. Though the de facto standard InstantRails hasn&#8217;t been updated in quite some time (RubyForge says since 2007!) and the One-Click Ruby Installer is still 1.8.6, there are some new up and coming options out there that present newer stacks.</p>

<p>The newest community produced effort is RubyInstaller. It&#8217;s currently still in pre-release (at time of writing, RC2), but it&#8217;s available for download in a 1.8.7 or 1.9 build. From the chatter I&#8217;ve heard, it works quite well and will likely replace InstantRails as the default community stack fairly soon. There&#8217;s also a company named Bitnami which produces the Bitnami RubyStack; this stack is based on 1.8.7 and comes with a significant set of extra things already installed.</p>

<p>Once you get a base Ruby installation working for you, you may want to look into <code style='background-color: #dddddd;'>pik</code>, which is basically <code style='background-color: #dddddd;'>rvm</code> for Windows. To install <code style='background-color: #dddddd;'>pik</code>, simply install the gem:</p>

<pre style='background-color: #dddddd;'><code>`gem install pik`</code></pre>

<p>Then, you probably want to run <code style='background-color: #dddddd;'>pik update</code> to get the latest version. Once it&#8217;s updated, you can install Ruby versions using <code style='background-color: #dddddd;'>pik install</code> or add existing binary versions on your system using <code style='background-color: #dddddd;'>pik add</code>. To use one of the installed Ruby versions, simple run <code style='background-color: #dddddd;'>pik use 1.9.1</code> or whatever the version identifier is.</p>

<h4 id='installing_rails_3'><span class='maruku_section_number'>3.1.2. </span>Installing Rails 3</h4>

<p>Now that you have a proper Ruby, it&#8217;s time to get a proper Rails. At this point, installing the Rails 3 can be sort of tricky since there are dependencies, it&#8217;s a prerelease gem, and RubyGems basically poops the bed when those two scenarios collide. Hopefully that&#8217;ll be fixed soon, but in the mean time, you can install Rails&#8217; dependencies like so:</p>

<pre style='background-color: #dddddd;'><code># rails3b is a metagem for all the dependencies
gem install rails3b
gem install arel --pre

# or if that gives you hassle, try the expanded version...
gem install i18n tzinfo builder memcache-client rack \
            rack-test rack-mount erubis mail text-format thor bundler</code></pre>

<p>Once all those lovely gems are installed (add <code style='background-color: #dddddd;'>--no-ri</code> and <code style='background-color: #dddddd;'>--no-rdoc</code> if you want to skip those/speed up your install), then install the prerelease version of Rails:</p>

<pre style='background-color: #dddddd;'><code>gem install rails --pre</code></pre>

<p>That should install a gem named <code style='background-color: #dddddd;'>rails 3.0.0.beta</code>, and if you run <code style='background-color: #dddddd;'>rails --version</code>, you should see &#8220;Rails 3.0.0.beta&#8221;. Now you&#8217;re ready to roll on with the Rails beta!</p>

<h3 id='automating_some_of_the_upgrade_'><span class='maruku_section_number'>3.2. </span>Automating some of the upgrade: <code style='background-color: #dddddd;'>rails_upgrade</code></h3>

<p>I&#8217;m going to show you the process of manually upgrading a Rails application, but if you&#8217;re lazy like me, then you can automate part of the process with a plugin I wrote named <code style='background-color: #dddddd;'>rails_upgrade</code>. <code style='background-color: #dddddd;'>rails_upgrade</code> is an officially blessed upgrade tool that will be maintained by myself and the Rails team throughout the 2.x to 3.0 transition period. To install the plugin, simply grab it from Github:</p>

<pre style='background-color: #dddddd;'><code>script/plugin install git://github.com/rails/rails\_upgrade.git</code></pre>

<p>The plugin adds the following Rake tasks to your application:</p>

<pre style='background-color: #dddddd;'><code>rake rails:upgrade:check
rake rails:upgrade:gems
rake rails:upgrade:routes     
rake rails:upgrade:backup
rake rails:upgrade:configuration</code></pre>

<p>The name of each task is probably self explanatory, but here&#8217;s a quick rundown of what each one is capable of.</p>

<h4 id='_find_out_what_needs_to_be_upgraded'><span class='maruku_section_number'>3.2.1. </span><code style='background-color: #dddddd;'>rails:upgrade:check</code>: Find out what needs to be upgraded</h4>

<p>I&#8217;ve assembled a battery of tests to run on your app for obvious things that need to be upgraded and placed them into the <code style='background-color: #dddddd;'>rails:upgrade:check</code>. To get a report, simply run this in a Rails root:</p>

<pre style='background-color: #dddddd;'><code>rake rails:upgrade:check</code></pre>

<p>The task checks over some things and generates a series of warnings similar to this:</p>

<pre style='background-color: #dddddd;'><code>named_scope is now just scope
The named_scope method has been renamed to just scope.
More information: http://github.com/rails/...

The culprits: 
	- app/models/group.rb
	- app/models/post.rb</code></pre>

<p>It shows and explains the issue, where to get more information on it, and which files the issue was found in. It checks for a wide range of issues (e.g., looks for old generators, busted plugins, environment.rb conversion requirements, old style routes and constants, etc.), so please use it since it will save you a lot of time, even if you don&#8217;t use the rest of the plugin. It doesn&#8217;t cover everything 100% probably, but I&#8217;ve found it&#8217;s great for quickly identifying some low hanging fruit in upgrading.</p>

<h4 id='_upgrading_routes'><span class='maruku_section_number'>3.2.2. </span><code style='background-color: #dddddd;'>rails:upgrade:routes</code>: Upgrading routes</h4>

<p>There is also a task to evaluate the routes in your current <code style='background-color: #dddddd;'>routes.rb</code> file and generate new code for Rails 3. To generate a new routes file, simply run the task inside your Rails application:</p>

<pre style='background-color: #dddddd;'><code>rake rails:upgrade:routes</code></pre>

<p>I&#8217;ve tested it on some quite complicated routes files and it did fine, but it does have some minor quirks (i.e., it flattens <code style='background-color: #dddddd;'>with_options</code> blocks currently, expanding the options into the routes rather than retaining the <code style='background-color: #dddddd;'>with_options</code> block). So, the task will take a routes file like:</p>

<pre style='background-color: #dddddd;'><code>ActionController::Routing::Routes.draw do |map|
  map.resources :posts, :collection =&gt; {:drafts =&gt; :get, :published =&gt; :get}

  map.login  &#39;/login&#39;,  :controller =&gt; &#39;sessions&#39;, :action =&gt; &#39;new&#39;

  map.connect &#39;:controller/:action/:id.:format&#39;
  map.connect &#39;:controller/:action/:id&#39;
end</code></pre>

<p>And makes a new one like this:</p>

<pre style='background-color: #dddddd;'><code>YourApp::Application.routes do
  resources :posts do
    collection do
      get :drafts
      get :published
    end  
  end
  
  match &#39;/login&#39; =&gt; &#39;sessions#new&#39;, :as =&gt; :login
  match &#39;/:controller(/:action(/:id))&#39;
end</code></pre>

<p>The formatting isn&#8217;t quite this nice when it comes straight out of the script, but you get the idea. This task is ideal for generating a base routes file quickly that you can refactor into something more manageable.</p>

<h4 id='_creating_gemfiles'><span class='maruku_section_number'>3.2.3. </span><code style='background-color: #dddddd;'>rails:upgrade:gems</code>: Creating Gemfiles</h4>

<p>The next piece is a Gemfile generator; essentially it takes your <code style='background-color: #dddddd;'>config.gem</code> directives in <code style='background-color: #dddddd;'>environment.rb</code> and generates a nice <code style='background-color: #dddddd;'>Gemfile</code> for the new gem bundler (see section *** for more information on that). To run it, simply execute:</p>

<pre style='background-color: #dddddd;'><code>rake rails:upgrade:gems</code></pre>

<p>That will take an <code style='background-color: #dddddd;'>environment.rb</code> with these <code style='background-color: #dddddd;'>config.gem</code> calls:</p>

<pre style='background-color: #dddddd;'><code>config.gem &quot;bj&quot;
config.gem &quot;aws-s3&quot;, :lib =&gt; &quot;aws/s3&quot;</code></pre>

<p>And generate this <code style='background-color: #dddddd;'>Gemfile</code>:</p>

<pre style='background-color: #dddddd;'><code>directory &quot;/path/to/rails&quot;, :glob =&gt; &quot;{*/,}*.gemspec&quot;
git &quot;git://github.com/rails/rack.git&quot;
gem &quot;rails&quot;, &quot;3.0.pre&quot;

gem &#39;bj&#39;, 
gem &#39;aws-s3&#39;, :require_as=&gt;&quot;aws/s3&quot;</code></pre>

<p>Then it&#8217;s just as simple as <code style='background-color: #dddddd;'>bundle install</code> to get your gems setup and installed (or optionally <code style='background-color: #dddddd;'>bundle pack</code> if you&#8217;d like to freeze everything). I&#8217;ve tested this on some fairly complex sets of gem requirements, so it should stand up to most sets of gem requirements.</p>

<h4 id='_backing_up_important_files'><span class='maruku_section_number'>3.2.4. </span><code style='background-color: #dddddd;'>rails:upgrade:backup</code>: Backing up important files</h4>

<p>Upgrading may require overwriting some files that you&#8217;ve probably made heavy modification to, so this task will back those files up. If you execute the task (<code style='background-color: #dddddd;'>rake rails:upgrade:backup</code>), the code will take files like <code style='background-color: #dddddd;'>test/test_helper.rb</code> and create a backup in the form of <code style='background-color: #dddddd;'>test/test_helper.rb.rails2</code>. You can see a full list of what it will back up below when we actually begin the upgrade.</p>

<h4 id='_generating_your_new_configuration_files'><span class='maruku_section_number'>3.2.5. </span><code style='background-color: #dddddd;'>rails:upgrade:configuration</code>: Generating your new configuration files</h4>

<p>The last piece of the plugin is a configuration file generator. As mentioned previously, Rails has transitioned to using Rack pretty deep in the stack. Part of that transition has been to move from configuring your application <code style='background-color: #dddddd;'>environment.rb</code> to a new file named <code style='background-color: #dddddd;'>application.rb</code>, where you Rails application creates a Rack endpoint and is configured. This task will take your Rails initializer configuration from <code style='background-color: #dddddd;'>environment.rb</code> and create new configuration code that you can drop into <code style='background-color: #dddddd;'>application.rb</code>.</p>

<h3 id='starting_an_upgrade_with_the_plugin'><span class='maruku_section_number'>3.3. </span>Starting an upgrade with the plugin</h3>

<p>Now it&#8217;s time to start upgrading your application. There are three steps to starting an upgrade using the <code style='background-color: #dddddd;'>rails_upgrade</code> plugin:</p>

<ol>
<li>Run the application check</li>

<li>Back up your important files</li>

<li>Re-generate the application on top of your previous application</li>
</ol>

<p>These preliminary steps followed by some guided reconfiguration and code upgrading will bring your Rails application up to version 3 compatibility, but first we need to figure out what those following steps will be.</p>

<h4 id='run_the_application_checks'><span class='maruku_section_number'>3.3.1. </span>Run the application checks</h4>

<p>First, run <code style='background-color: #dddddd;'>rake rails:upgrade:check</code>. This will generate a report on what needs to be upgraded in your application. You&#8217;ll probably see things about deprecated API calls and changing DSL&#8217;s, but don&#8217;t start working on those problems yet! The next two steps will take care of a few of the issues that it points out. I just wanted you to run the check to layout a roadmap for where we&#8217;re going.</p>

<h4 id='back_up_important_files'><span class='maruku_section_number'>3.3.2. </span>Back up important files</h4>

<p>In the next step, we&#8217;re going to &#8220;regenerate&#8221; the Rails app on top of your current Rails 2.x app (in effect, generating a new Rails 3 app with your application code in it), but be careful which files you let the generator replace since a lot of them can be edited much more simply than they can be reconstructed (unless you really like digging around in <code style='background-color: #dddddd;'>git diff</code> and previous revisions). Fortunately for you, the <code style='background-color: #dddddd;'>rails:upgrade:backup</code> task will backup anything that you probably made modifications to, but if you don&#8217;t use that task, here&#8217;s a list of files you probably do not want to let it update (since you likely made modifications):</p>

<ul>
<li><code style='background-color: #dddddd;'>.gitignore</code> (unless you don&#8217;t really care; the new standard one is pretty good)</li>

<li><code style='background-color: #dddddd;'>app/helpers/application_helper.rb</code></li>

<li><code style='background-color: #dddddd;'>config/routes.rb</code></li>

<li><code style='background-color: #dddddd;'>config/environment.rb</code></li>

<li><code style='background-color: #dddddd;'>config/environments/*</code> (unless you haven&#8217;t touched these as many people don&#8217;t)</li>

<li><code style='background-color: #dddddd;'>config/database.yml</code></li>

<li><code style='background-color: #dddddd;'>doc/README_FOR_APP</code> (you <em>do</em> write this, don&#8217;t you?)</li>

<li><code style='background-color: #dddddd;'>test/test_helper.rb</code></li>
</ul>

<p>Whether you use the plugin or not, you need to let Rails overwrite these:</p>

<ul>
<li><code style='background-color: #dddddd;'>Rakefile</code></li>

<li><code style='background-color: #dddddd;'>README</code></li>

<li><code style='background-color: #dddddd;'>config/boot.rb</code></li>

<li><code style='background-color: #dddddd;'>public/404.html</code> (unless you&#8217;ve customized it)</li>

<li><code style='background-color: #dddddd;'>public/500.html</code> (unless you&#8217;ve customized it)</li>

<li><code style='background-color: #dddddd;'>public/javascripts/*</code> (if you don&#8217;t have a lot of version dependent custom JavaScript; Rails is JavaScript framework agnostic now so there have been changes and additions to the JavaScript included)</li>
</ul>

<p>Of course, these lists won&#8217;t apply in every situation, but in general I think that&#8217;s how it&#8217;ll break down. Now that you&#8217;ve generated the Rails 3 code, you can remove everything in <code style='background-color: #dddddd;'>script/</code> except <code style='background-color: #dddddd;'>script/rails</code>, since everything now revolves around the <code style='background-color: #dddddd;'>rails</code> command (I&#8217;ll get to that in more detail later).</p>

<h3 id='regenerate_the_application'><span class='maruku_section_number'>3.4. </span>Regenerate the application</h3>

<p>Now that your application files are prepped, you need to &#8220;generate a new app&#8221; on top of your current one (i.e., run the generator and point the app path to your current Rails 2.x app&#8217;s path). You could go in and paste or change these files manually, but doing it this way is much quicker and less error prone.</p>

<pre style='background-color: #dddddd;'><code>rails ~/code/my_rails2_app/</code></pre>

<p>The application generator is basically the same with two key differences:</p>

<ul>
<li>The parameter that was formerly the app name is now the app path. You can still give it a &#8220;name,&#8221; and it will create the folder like normal. But you can also give it a full path (e.g., <code style='background-color: #dddddd;'>~code/my_application</code> rather than just <code style='background-color: #dddddd;'>my_application</code>) and it will create the application there.</li>

<li>All parameters for the generator must go after the app path. So, previously one could do <code style='background-color: #dddddd;'>rails -d mysql test_app</code>, but now that has to be <code style='background-color: #dddddd;'>rails test_app -d mysql</code>. This change is largely due to the major refactoring of the Rails generators, so even though it&#8217;s somewhat of a temporary annoyance, it&#8217;s definitely worth it for the flexibility and power that the new generators bring (more on that soon).</li>
</ul>

<p>If you get an error like &#8220;no value provided for required arguments &#8216;app_path&#8217;&#8220;, then you&#8217;ve gotten your parameters out of order. If you&#8217;d like to use another database driver, you can provide <code style='background-color: #dddddd;'>postgresql</code> or <code style='background-color: #dddddd;'>sqlite</code> (or nothing, since <code style='background-color: #dddddd;'>sqlite</code> is the default). You&#8217;ll see a lot of text scroll by, and now we have a nice, fresh Rails 3 application to play with.</p>

<p>Note that the argument is a <em>path</em>, not a name as in previous Rails versions. When the generator runs, it will ask you if you want to replace a lot of files. If you&#8217;ve backed them up, just enter &#8220;a&#8221; it will overwrite them without asking you about each and every file.</p>

<blockquote>
<p><strong>PROTIP:</strong> If you got an error about your Ruby version, upgrade it! If you use rvm (http://rvm.beginrescueend.com/) it&#8217;ll be totally painless.</p>
</blockquote>

<p>Congratulations, you&#8217;ve got a probably-not-booting-but-still-existent Rails 3 application. Now, let&#8217;s get that application booting and running!</p>

<h2 id='getting_bootable'><span class='maruku_section_number'>4. </span>Getting bootable</h2>

<p>So, you&#8217;ve prepped the application, got the new files generated, and are now ready to move forward with the upgrade. First, we&#8217;re going to get the application reconfigured with the new style configuration files, and then we&#8217;ll make some essential code changes.</p>

<h3 id='configuring_your_app_again'><span class='maruku_section_number'>4.1. </span>Configuring your app again</h3>

<p>Now comes the task of configuration. There aren&#8217;t a whole ton of changes or anything, but navigating them can trip up the novice and journey(wo)man alike. Things like initializers and your settings in <code style='background-color: #dddddd;'>database.yml</code> can generally stay the same; the main thrust of the changes have to do with <code style='background-color: #dddddd;'>environment.rb</code>, the router, and gem vendoring.</p>

<blockquote>
<p><strong>PROTIP:</strong> When using SQLite, the database file is now the <code style='background-color: #dddddd;'>database</code> key rather than the <code style='background-color: #dddddd;'>dbfile</code> key.</p>
</blockquote>

<h3 id='configuring_the_environment'><span class='maruku_section_number'>4.2. </span>Configuring the environment</h3>

<p>In all previous Rails versions, most configuration and initialization happened in <code style='background-color: #dddddd;'>config/environment.rb</code>, but in Rails 3, most of this logic is moved to <code style='background-color: #dddddd;'>config/application.rb</code> and a host of special initializers in <code style='background-color: #dddddd;'>config/initializers</code>. If open up <code style='background-color: #dddddd;'>config/environment.rb</code>, you&#8217;ll notice it&#8217;s been seriously slimmed down and looks like this now:</p>

<pre style='background-color: #dddddd;'><code># Load the rails application
require File.expand_path(&#39;../application&#39;, __FILE__)

# Initialize the rails application
YourApp::Application.initialize!</code></pre>

<p>Simple: the <code style='background-color: #dddddd;'>application.rb</code> file is required and then the <code style='background-color: #dddddd;'>Application</code> (Rack endpoint for your Rails application) is initialized. The <code style='background-color: #dddddd;'>YourApp</code> constant is generated based on the folder name for your app (i.e., <code style='background-color: #dddddd;'>rails ~/code/my_super_app</code> would make it <code style='background-color: #dddddd;'>MySuperApp</code>). The constant doesn&#8217;t have any special relationship to the folder the app lives in so you can rename it at will (so long as you do it everywhere it&#8217;s used), but you&#8217;ll be using this constant in a few places, so if you change it be sure to make it something useful.</p>

<p>Now open up <code style='background-color: #dddddd;'>application.rb</code>; if you generated the files using the Rails 3 generator, you should have one that looks something like this:</p>

<pre style='background-color: #dddddd;'><code>module TestDevApp
  class Application &lt; Rails::Application
    # ...Insert lots of example comments here...
    
    # Configure sensitive parameters which will be filtered from the log file.
    config.filter_parameters &lt;&lt; :password
  end
end</code></pre>

<p>For the most part, all the code inside the Rails initializer block (i.e., all your <code style='background-color: #dddddd;'>config.*</code> calls) from your old <code style='background-color: #dddddd;'>environment.rb</code> should transfer straight over: just use the <code style='background-color: #dddddd;'>rails:upgrade:configuration</code> method or copy and paste them inside the class body. That part of the configuration is simple; if you have any extraneous code outside of that configuration block, I heartily recommend that you move it into either an initializer or into the bottom of <code style='background-color: #dddddd;'>application.rb</code>.</p>

<p>Next, take a look at some of the newly generated code. You&#8217;ll notice a block like this:</p>

<pre style='background-color: #dddddd;'><code>config.generators do |g|
  g.orm             :active_record
  g.template_engine :erb
  g.test_framework  :test_unit, :fixture =&gt; true
end</code></pre>

<p>This is where you can configure what ORM, test framework, and template engine that Rails will use. Since you&#8217;re upgrading existing code, you&#8217;ll probably stick with the defaults (unless, of course, you&#8217;re already using something like <code style='background-color: #dddddd;'>haml</code>), but you could substitute in something like <code style='background-color: #dddddd;'>:datamapper</code> or <code style='background-color: #dddddd;'>:sequel</code> for <code style='background-color: #dddddd;'>:active_record</code>, <code style='background-color: #dddddd;'>:haml</code> for <code style='background-color: #dddddd;'>:erb</code>, or <code style='background-color: #dddddd;'>:rspec</code> for <code style='background-color: #dddddd;'>:test_unit</code> (once they get it working with Rails 3). Doing so will set the generators for models, views, etc. to use your tool of choice; for example, if you generate a scaffold with <code style='background-color: #dddddd;'>haml</code> and <code style='background-color: #dddddd;'>rspec</code> as your tools, it should in theory generate the templates with Haml syntax and the tests using RSpec (I don&#8217;t know if all these generators are available yet, but they should be soon).</p>

<p>The <code style='background-color: #dddddd;'>config/application.rb</code> file also houses some configuration for other things.</p>

<ul>
<li>If you need to configure internationalization, it&#8217;s been moved to <code style='background-color: #dddddd;'>application.rb</code>. Rails 3 comes equipped with a really powerful i18n toolkit powered by the <code style='background-color: #dddddd;'>i18n</code> gem<em class='fn'>http://github.com/svenfuchs/i18n</em>. The defaults that Rails sets up will work for most people (default locale is <code style='background-color: #dddddd;'>en</code> and all translations in the default directory are automatically imported), so you may not need to touch anything, but if you need to customize, this is the place to do it.</li>

<li>You may want to set a default timezone. I usually stick with UTC since it&#8217;s easy to convert on a per-user basis to their desired timezone, but you might want to set it your timezone or the server&#8217;s timezone.</li>

<li>Your favorite old haunts from <code style='background-color: #dddddd;'>config/environment.rb</code> such as <code style='background-color: #dddddd;'>config.plugins</code>, <code style='background-color: #dddddd;'>config.load_paths</code>, etc. are still there (even though <code style='background-color: #dddddd;'>config.gems</code> is not).</li>
</ul>

<p>Other configuration bits like custom inflections, mime types, and so on have been moved out into their own initializers that you can find under <code style='background-color: #dddddd;'>config/initializers</code>. You&#8217;ll also notice that many things that were once in <code style='background-color: #dddddd;'>environment.rb</code> have been moved out into new initializers (such as custom inflections). You&#8217;ll probably want to/have to move these things out of <code style='background-color: #dddddd;'>application.rb</code> and into the proper initializer.</p>

<p>If you opted to keep any custom initializers or specialized environment file during the generation process, you&#8217;ll probably need to go in there and update the syntax. Many of these (especially the environment files like <code style='background-color: #dddddd;'>config/environments/production.rb</code>) now requires a new block syntax:</p>

<pre style='background-color: #dddddd;'><code># Rails 2.x
config.cache_classes = false
config.action_controller.perform_caching = true

# Rails 3.x
YourApp::Application.configure do
  config.cache_classes = false
  config.action_controller.perform_caching = true
end</code></pre>

<p>All configuration happens inside the <code style='background-color: #dddddd;'>Application</code> object for your Rails app, so these configuration files, too, need to be executed inside of it. As I said previously, most things in there should still work fine once wrapped in the block.</p>

<h4 id='converting_your_routes_file'><span class='maruku_section_number'>4.2.1. </span>Converting your routes file</h4>

<p>The next step is to move your routes to the Rails 3 router syntax. The new router is great, but it&#8217;s not incredibly easy to migrate existing routes over to the new syntax. Upgrading your routes is fairly simple so long as you haven&#8217;t done anything complex; it&#8217;s just not as easy as copying and pasting. Some things, like <code style='background-color: #dddddd;'>namespaces</code> work the same, but most other things have a much changed syntax.</p>

<blockquote>
<p><strong>PROTIP</strong>: You don&#8217;t <em>have</em> to upgrade your routes immediately; the Rails core team has a legacy mapper in place at least until Rails 3.1. It is recommended that you do it as soon as possible, though, since that mapper will not always be there.</p>
</blockquote>

<p>You can automate upgrading your routes file with the <code style='background-color: #dddddd;'>rails:upgrade:routes</code> task; it should handle nearly every case you throw at it. In case it doesn&#8217;t though, I&#8217;m going to walk through some manual upgrade cases. To start with the simplest case, mapping the root route (i.e., for the &#8221;/&#8221; path) previously looked like this:</p>

<pre style='background-color: #dddddd;'><code>map.root :controller =&gt; &#39;home&#39;, :action =&gt; &#39;index&#39;</code></pre>

<p>This maps the root path to the <code style='background-color: #dddddd;'>index</code> action on <code style='background-color: #dddddd;'>HomeController</code>. In Rails 3, a functionally equivalent route is:</p>

<pre style='background-color: #dddddd;'><code>root :to =&gt; &#39;home#index&#39;</code></pre>

<p>Note that rather than specify the controller and action as hash arguments they are now specified in a pattern typically seen in documentation (i.e., &#8220;class#method&#8221;). Moving up the complexity scale, to convert a simple, normal route, start with a route like:</p>

<pre style='background-color: #dddddd;'><code>map.connect &#39;/posts/mine&#39;, :controller =&gt; &#39;posts&#39;, :action =&gt; &#39;index&#39;</code></pre>

<p>This connects the path &#8220;http://example.com/posts/mine&#8221; to the <code style='background-color: #dddddd;'>index</code> action on <code style='background-color: #dddddd;'>PostsController</code>. The equivalent route in Rails 3 looks like this:</p>

<pre style='background-color: #dddddd;'><code>match &#39;/posts/mine&#39;, :to =&gt; &#39;posts#index&#39;</code></pre>

<p>If you wanted to provide extra parameters, you would simply follow the same pattern as in Rails 2.x:</p>

<pre style='background-color: #dddddd;'><code>map.connect &#39;/mine&#39;, :controller =&gt; &#39;posts&#39;, :action =&gt; &#39;index&#39;, 
                     :type =&gt; &#39;mine&#39;</code></pre>

<p>Notice in the following Rails 3 route that adding a default parameter looks very similar:</p>

<pre style='background-color: #dddddd;'><code>match &#39;/mine&#39;, :to =&gt; &#39;posts#index&#39;, :type =&gt; &#39;mine&#39;</code></pre>

<p>The syntax for named routes (i.e., routes that generate a helper like <code style='background-color: #dddddd;'>posts_path</code>) is also significantly different. A named route in Rails 2.x looks something like this:</p>

<pre style='background-color: #dddddd;'><code>map.login &#39;/login&#39;, :controller =&gt; &#39;sessions&#39;, :action =&gt; &#39;new&#39;</code></pre>

<p>This route generates helper methods named <code style='background-color: #dddddd;'>login_path</code> and <code style='background-color: #dddddd;'>login_url</code> and connects the path &#8216;http://example.com/login&#8217; to the <code style='background-color: #dddddd;'>new</code> action on <code style='background-color: #dddddd;'>SessionsController</code>. In Rails 3, this route looks like this:</p>

<pre style='background-color: #dddddd;'><code>match &#39;/login&#39;, :to =&gt; &#39;sessions#new&#39;, :as =&gt; &#39;login&#39;</code></pre>

<p>Note that the method called remains the same (unlike in Rails 2.x), but we add an <code style='background-color: #dddddd;'>:as</code> parameter to indicate what the route is named.</p>

<p>Resource routes have seen a significant shift also. Previously, specifying special methods for the collection and members of the collection of resources required a sticky looking set of hashes:</p>

<pre style='background-color: #dddddd;'><code>map.resources :users, :member =&gt; {:ban =&gt; :post} do |users|
  # Child routes here...
end</code></pre>

<p>In Rails 3, these methods are broken out into their own block inside the <code style='background-color: #dddddd;'>resources</code> block:</p>

<pre style='background-color: #dddddd;'><code>resources :users do
  member do
    post :ban
  end
end</code></pre>

<p>Member methods go in a <code style='background-color: #dddddd;'>member</code> block, <code style='background-color: #dddddd;'>collection</code> methods go in a <code style='background-color: #dddddd;'>collection</code> block. Also note the form of request method as the method call, the action name as a <code style='background-color: #dddddd;'>Symbol</code> argument; the order is reversed from the previous syntax.</p>

<p>Nesting another set of resources inside of a resource in Rails 2.x looked like this:</p>

<pre style='background-color: #dddddd;'><code>map.resources :posts do |post|
  post.resources :comments
  post.resources :spams
end</code></pre>

<p>In Rails 3, this syntax is cleaned up a little bit:</p>

<pre style='background-color: #dddddd;'><code>resources :posts do
  resources :comments
  resources :spams
end</code></pre>

<p>Note the lack of block variable and method calls on it; as you&#8217;ve seen in other route conversion examples, the new router does away with that sort of syntax.</p>

<p>If you have routes with requirements, such as a name parameter having to be a certain string or id&#8217;s having to match a certain pattern, Rails 3 also supports those with a different syntax. For example, let&#8217;s say you have a route that said a <code style='background-color: #dddddd;'>participant_id</code> parameter had to start with 2 letters followed by numbers; in Rails 2.x, that would look like this:</p>

<pre style='background-color: #dddddd;'><code>map.connect &#39;/people/participants/:participant_id&#39;, :controller =&gt; &#39;participants&#39;,
            :action =&gt; &#39;show&#39;, :requirements =&gt; { :participant_id =&gt; /^[a-z]{2}\d+/i}</code></pre>

<p>The <code style='background-color: #dddddd;'>:requirements</code> argument specifies what parameter to check and a pattern to check it with. The syntax is very similar in Rails 3, but with a different name:</p>

<pre style='background-color: #dddddd;'><code>match &#39;/people/participants/:participant_id&#39;, :to =&gt; &#39;participants#show&#39;, 
      :constraints =&gt; { :participant_id =&gt; /^[a-z]{2}\d+/i}</code></pre>

<p>So, essentially the <code style='background-color: #dddddd;'>requirements</code> argument is now the <code style='background-color: #dddddd;'>constraints</code> argument, but it&#8217;s not exactly the same: Rails 3 makes the constraints/requirements mechanism much more robust. You can read about some of the new features in Section 4.3.</p>

<h4 id='setting_up_the_gem_bundler'><span class='maruku_section_number'>4.2.2. </span>Setting up the gem bundler</h4>

<p>Rails 2&#8217;s gem vendoring solution left much to be desired: between issues with requiring the gems properly to problems with the gem detection (I can&#8217;t tell you how many times I nixed a gem from the list because it kept telling me to install it even though it was already installed), Rails seriously needed a replacement for such a vital piece of infrastructure. These days we have Yehuda Katz&#8217;s excellent bundler<em class='fn'>http://github.com/carlhuda/bundler</em>, which totally replaces <code style='background-color: #dddddd;'>config.gem</code> in Rails 3.</p>

<p>Essentially, bundler works off of <code style='background-color: #dddddd;'>Gemfiles</code> (kind of like <code style='background-color: #dddddd;'>Rakefiles</code> in concept) that contain a description of what gems to get, how to get them, and when to get them. Moving your gem requirements to a <code style='background-color: #dddddd;'>Gemfile</code> isn&#8217;t as simple as copying them over. You can automate it using <code style='background-color: #dddddd;'>rails:upgrade:gems</code>, but in the interest of greenfielding new apps with Rails 3 (or possibly using Bundler in non-Rails applications), I&#8217;m going to walk you through how to setup a Gemfile and convert your Rails 2 code to it.</p>

<p>Converting a Rails 2 <code style='background-color: #dddddd;'>config.gem</code> call to a <code style='background-color: #dddddd;'>Gemfile</code> directive isn&#8217;t terribly difficult; for example, here&#8217;s a pretty hairy <code style='background-color: #dddddd;'>config.gem</code> call:</p>

<pre style='background-color: #dddddd;'><code>config.gem &quot;aws-s3&quot;, :version =&gt; &quot;0.5.1&quot;, 
           :lib =&gt; &quot;aws/s3&quot;, :source =&gt; &quot;http://gems.omgbloglol.com&quot;</code></pre>

<p>So we want the <code style='background-color: #dddddd;'>aws-s3</code> gem, version <code style='background-color: #dddddd;'>0.5.1</code>, from a custom source, and it must be required as <code style='background-color: #dddddd;'>aws/s3</code> in our app. In a <code style='background-color: #dddddd;'>Gemfile</code>, it looks like this:</p>

<pre style='background-color: #dddddd;'><code>source &quot;http://gems.omgbloglol.com&quot;
gem &quot;aws-s3&quot;, &quot;0.5.1&quot;, :require =&gt; &quot;aws/s3&quot;</code></pre>

<p>So <code style='background-color: #dddddd;'>:source</code> parameters become <code style='background-color: #dddddd;'>source</code> calls <em>before</em> the gem that you want to fetch.</p>

<blockquote>
<p><strong>PROTIP:</strong> Sources don&#8217;t have to be added immediately before the gem, but do have to be added before that particular gem requirement.</p>
</blockquote>

<p>The version is now simply the second string requirement; if this is left out (i.e., you simply had <code style='background-color: #dddddd;'>gem &quot;aws-s3&quot;, :require =&gt; &quot;aws/s3&quot;</code>), it will assume you want the latest version. And finally, the <code style='background-color: #dddddd;'>:lib</code> argument is now <code style='background-color: #dddddd;'>:require</code> (which makes more sense). So, to sum up the changes:</p>

<ul>
<li>Remove the <code style='background-color: #dddddd;'>config</code> object</li>

<li><code style='background-color: #dddddd;'>:lib</code> key becomes the <code style='background-color: #dddddd;'>:require</code> key</li>

<li>The <code style='background-color: #dddddd;'>:version</code> key becomes a second, optional string argument</li>

<li>Move <code style='background-color: #dddddd;'>:source</code> arguments to a <code style='background-color: #dddddd;'>source</code> call to add it to the sources</li>
</ul>

<p>Now let&#8217;s take a look at the <code style='background-color: #dddddd;'>Gemfile</code> that Rails generated for you:</p>

<pre style='background-color: #dddddd;'><code># Edit this Gemfile to bundle your application&#39;s dependencies.
source :gemcutter

gem &quot;rails&quot;, &quot;3.0.0.beta&quot;

## Bundle edge rails:
# gem &quot;rails&quot;, :git =&gt; &quot;git://github.com/rails/rails.git&quot;

gem &quot;mysql&quot;

## Bundle the gems you use:
# gem &quot;bj&quot;
# gem &quot;hpricot&quot;, &quot;0.6&quot;
# gem &quot;sqlite3-ruby&quot;, :require =&gt; &quot;sqlite3&quot;
# gem &quot;aws-s3&quot;, :require =&gt; &quot;aws/s3&quot;

## Bundle gems used only in certain environments:
# gem &quot;rspec&quot;, :group =&gt; :test
# group :test do
#   gem &quot;webrat&quot;
# end</code></pre>

<p>Notice that it has added <code style='background-color: #dddddd;'>mysql</code> as a dependency; when I generated this app, that&#8217;s what I set as the database driver via the <code style='background-color: #dddddd;'>-d</code> option. Were you to specify something else (like <code style='background-color: #dddddd;'>pg</code> or <code style='background-color: #dddddd;'>sqlite</code>) it would have the proper dependency.</p>

<p>As mentioned before, <code style='background-color: #dddddd;'>bundler</code> is much more powerful than <code style='background-color: #dddddd;'>config.gem</code>, and one of the great features it adds is the concept of a gem &#8220;group.&#8221; You can specify a group of gems to only be required/activated in certain environments, so you can stop doing weird things with environment checks around your <code style='background-color: #dddddd;'>config.gem</code> requirements. You can see an example of this technique in the commented out requirements at the bottom of the generated <code style='background-color: #dddddd;'>Gemfile</code>. So, let&#8217;s say I want to use <code style='background-color: #dddddd;'>mocha</code>, but only when testing (obviously). I would add this to <code style='background-color: #dddddd;'>Gemfile</code>:</p>

<pre style='background-color: #dddddd;'><code>group :test do
  gem &quot;mocha&quot;
end

# or...

gem &quot;mocha&quot;, :group =&gt; :test</code></pre>

<p>Now this gem will only be added in when running the app in the <code style='background-color: #dddddd;'>testing</code> environment. This technique is also useful for production only gems related to caching and what not.</p>

<p>Now that you&#8217;ve got a proper <code style='background-color: #dddddd;'>Gemfile</code>, run <code style='background-color: #dddddd;'>bundle pack</code> if you want to vendor everything or <code style='background-color: #dddddd;'>bundle install</code> to install the gems to system gems. The <code style='background-color: #dddddd;'>bundler</code> is much more powerful than <code style='background-color: #dddddd;'>config.gem</code>, and it helps you do more advanced tasks (e.g., bundle directly from a Git repository as you can see in the generated <code style='background-color: #dddddd;'>Gemfile</code>, specify granular paths, etc.). So, once you move your <code style='background-color: #dddddd;'>config.gem</code> calls over, you may want to look into the new features<em class='fn'>http://github.com/carlhuda/bundler/blob/master/README.markdown</em>.</p>

<h3 id='code_fixes'><span class='maruku_section_number'>4.3. </span>Code fixes</h3>

<p>Your application should be properly configured now, so let&#8217;s move on to changes you need to make in your application code. To get an application actually bootable, the changes will likely be fairly minimal if anything (unless you have a rogue plugin that will give you issues), but the following changes will be required in coming versions.</p>

<h4 id='_constants_are_deprecated'><span class='maruku_section_number'>4.3.1. </span><code style='background-color: #dddddd;'>RAILS_*</code> constants are deprecated</h4>

<p>In all previous versions of Rails, one referred to the root directory of a Rails application with <code style='background-color: #dddddd;'>RAILS_ROOT</code> or the environment with <code style='background-color: #dddddd;'>RAILS_ENV</code>. Well, these constants are going away in lieu of a nice module<em class='fn'>http://api.rubyonrails.org/classes/Rails.html</em> that houses all of them. For example, <code style='background-color: #dddddd;'>RAILS_ROOT</code> is now <code style='background-color: #dddddd;'>Rails.root</code>, <code style='background-color: #dddddd;'>RAILS_ENV</code> is now <code style='background-color: #dddddd;'>Rails.env</code>, etc.</p>

<blockquote>
<p><strong>PROTIP:</strong> These conversions aren&#8217;t absolutely required yet, but you will get a warning about them. The plan is to get rid of them very soon, so make sure you make the change as soon as you can.</p>
</blockquote>

<p>The nice thing about these new module methods is that you can replace code that looks like this:</p>

<pre style='background-color: #dddddd;'><code>if RAILS_ENV == &quot;production&quot;
  # ...
end</code></pre>

<p>&#8230;with something a little more readable:</p>

<pre style='background-color: #dddddd;'><code>if Rails.env.production?
  # ...
end</code></pre>

<p>This works with custom environments like <code style='background-color: #dddddd;'>staging_309</code> or <code style='background-color: #dddddd;'>production_on_my_box</code>, too. This sugar comes from a special class named <code style='background-color: #dddddd;'>ActiveSupport::StringInquirer</code> that lets you query the contents of the string (i.e., <code style='background-color: #dddddd;'>&quot;what&quot;.what?</code> would evaluate to <code style='background-color: #dddddd;'>true</code>).<em class='fn'>http://api.rubyonrails.org/classes/ActiveSupport/StringInquirer.html</em> Just another little touch of syntactic sugar to add some elegance.</p>

<h4 id='converting_mailers_to_the_new_api'><span class='maruku_section_number'>4.3.2. </span>Converting mailers to the new API</h4>

<p>The Action Mailer API has always been a sore spot in the Rails world: is it a controller or a model? Why does it act like a controller but live in models? Where do these magic methods come from? Fortunately for Rails 3, they&#8217;ve greatly de-metafied the code and made its API much more straightforward.</p>

<blockquote>
<p><strong>PROTIP:</strong> The old API currently works, but it&#8217;s a compatibility shim, which will be removed in a future version, so you should upgrade your mailers. Plus, the old API is icky.</p>
</blockquote>

<p>Let&#8217;s take a look at a basic user notification mailer from Rails 2.x.</p>

<pre style='background-color: #dddddd;'><code>class UserMailer &lt; ActionMailer::Base
  def new_friend_notification(user, friend)
    recipients      user.email
    from            &quot;notifier@example.com&quot;
    subject         &quot;You have a new friend!&quot;
    body            :user =&gt; user, :friend =&gt; friend
  end
end</code></pre>

<p>This mailer simply alerts a user when they have a new friend in their social network in our hypothetical app: the user receives the e-mail, we send it from our notifier e-mail address, and we pass the user and their new friend as body parameters (they will show up as instance variables to the template oddly enough). This API is sort of confusing (we&#8217;re setting attributes using simple method calls, which is sort of ugly) and looks nothing like anything else in Rails. Plus, it lacks anything like filters and so on, not to mention that to use it you have to use magical methods like <code style='background-color: #dddddd;'>deliver_new_friend_notification</code>. Now here&#8217;s the same mailer using the new Action Mailer API:</p>

<pre style='background-color: #dddddd;'><code>class UserMailer &lt; ActionMailer::Base
  default :from =&gt; &quot;notifier@example.com&quot;

  def new_friend_notification(user, friend)
    @user = user
    @friend = friend

    mail(:to =&gt; user.email, :subject =&gt; &quot;You have a new friend!&quot;)
  end
end</code></pre>

<p>Much cleaner and closer to what we&#8217;re used to. Instance variables are carried over from the parent class to the templates, and the object returned from the method is just an object that we call methods on to generate the e-mail or send it.</p>

<pre style='background-color: #dddddd;'><code>user = User.find(1337)
new_friend = User.find(42)

UserMailer.new_friend_notification(user, new_friend).deliver</code></pre>

<p>If you wanted the message as a string, you simply call <code style='background-color: #dddddd;'>to_s</code> on the object returned from the mailer method rather than calling <code style='background-color: #dddddd;'>create_*</code>.</p>

<p>The handling of attachments is a bit cleaner also. Previously, a mailer with attachments would look like this:</p>

<pre style='background-color: #dddddd;'><code>class AssetMailer &lt; ActionMailer::Base
  def send_purchased_asset(user, asset)
    recipients      recipient.email
    from            &quot;mailer@example.com&quot;
    
    subject         &quot;Here is your image: #{asset.name}&quot;
    body            :account =&gt; recipient

    attachment :content_type =&gt; &quot;image/jpeg&quot;,
               :body =&gt; File.read(asset.path)
  end
end</code></pre>

<p>Not terrible, but the <code style='background-color: #dddddd;'>:body</code> parameter is awkward since it&#8217;s not really a &#8220;body.&#8221; In Rails 3, this is just a bit more elegant:</p>

<pre style='background-color: #dddddd;'><code>class AssetMailer &lt; ActionMailer::Base
  def send_purchased_asset(user, asset)
    @user = user
    @asset = asset
    
    fn = File.basename(asset.path)
    attachments[fn] = File.read(asset.path)
    
    mail(:to =&gt; user.email, :from =&gt; &quot;mailer@example.com&quot;,
         :subject =&gt; &quot;Here is your image: #{asset.name}&quot;)
  end
end</code></pre>

<p>Simply populate the attachments hash with your attachment data and ActionMailer takes care of the rest. Once you get the syntax converted, move your mailers from <code style='background-color: #dddddd;'>app/models</code> to <code style='background-color: #dddddd;'>app/mailers</code> and you should be good to go.</p>

<h4 id='new_active_record_api'><span class='maruku_section_number'>4.3.3. </span>New Active Record API</h4>

<p>The Active Record DSL is radically different, largely thanks to its integration with Active Relation (see Section 1.1.3 for more information on the merge). The old API won&#8217;t be deprecated until Rails 3.1, but it&#8217;s probably a good idea to go ahead and start migrating as much as possible to the new API now. The simplest way to explain, at a practical level, how the new query API works is to explain it in terms of <code style='background-color: #dddddd;'>named_scopes</code> (now just <code style='background-color: #dddddd;'>scopes</code>, by the way). Let&#8217;s say you have the following model in an app on Rails 2.3:</p>

<pre style='background-color: #dddddd;'><code>class Post &lt; ActiveRecord::Base
  named_scope :published, :conditions =&gt; [&#39;published_at NOT NULL&#39;]
  named_scope :by, lambda {|u| :conditions =&gt; {:user_id =&gt; u.id}}
end</code></pre>

<p>You can chain up named scopes infinitely, so if you were to have code like <code style='background-color: #dddddd;'>Post.published.by(@user)</code>, it would find posts that were already published and written by the specified user. What&#8217;s actually going on there is that <code style='background-color: #dddddd;'>Post.published</code> returns a <code style='background-color: #dddddd;'>NamedScope</code> object which is then operated on again with the <code style='background-color: #dddddd;'>by</code> method, adding more conditions, composing the SQL query that you&#8217;ll eventually execute with a call like <code style='background-color: #dddddd;'>all</code> or <code style='background-color: #dddddd;'>find</code>.</p>

<p class='img'><img src='scopes.png' alt='Named scopes' /></p>

<p>Active Record/Active Relation work much the same way. When you call a method, Active Record returns a <code style='background-color: #dddddd;'>Relation</code>; these <code style='background-color: #dddddd;'>Relation</code> objects are chained, composing a SQL query, until you execute that query by calling an enumerable method like <code style='background-color: #dddddd;'>all</code>, <code style='background-color: #dddddd;'>first</code>, or <code style='background-color: #dddddd;'>each</code> (you may know this concept as <em>deferred execution</em> from other ORMs). So, if you wanted to find the first five <code style='background-color: #dddddd;'>Site</code> records that are active, you might do this in Rails 2:</p>

<pre style='background-color: #dddddd;'><code>Site.find(:all, :conditions =&gt; {:active =&gt; true}, :limit =&gt; 5)</code></pre>

<p>With Rails 3 and Active Relation, though, the code would look like this:</p>

<pre style='background-color: #dddddd;'><code>Site.where(:active =&gt; true).limit(5)</code></pre>

<p>Just like a <code style='background-color: #dddddd;'>named_scope</code>, these <code style='background-color: #dddddd;'>Relation</code> objects chain up with each other and compose the SQL query: <code style='background-color: #dddddd;'>Site.where</code> returns a <code style='background-color: #dddddd;'>Relation</code> that we call <code style='background-color: #dddddd;'>limit</code> on, which returns a <code style='background-color: #dddddd;'>Relation</code> that we call <code style='background-color: #dddddd;'>find</code> on.</p>

<p class='img'><img src='relations.png' alt='Relations' /></p>

<p>As you&#8217;ll see in Section 4.4, this new syntax opens up a lot of possibilities that either weren&#8217;t possible or were quite ugly with the old API.</p>

<p>Now, let&#8217;s take a look at converting some typical Rails 2.x model code into the new syntax. Not every piece of the API is changing; in fact, much of the large scale ideas are staying the same. Calls like <code style='background-color: #dddddd;'>Model.find(:all)</code>, <code style='background-color: #dddddd;'>Model.find(:first)</code>, and <code style='background-color: #dddddd;'>Model.find_by_field</code> will still work. It&#8217;s mostly the code surrounding the actual composition of the SQL query that is changing: essentially you can&#8217;t provide argument hashes for anything anymore. For example, here&#8217;s a simple query:</p>

<pre style='background-color: #dddddd;'><code>Post.find(:all, :conditions =&gt; {:category_id =&gt; @category.id})</code></pre>

<p>In Rails 3, the <code style='background-color: #dddddd;'>:conditions</code> hash is transformed into a call to <code style='background-color: #dddddd;'>where</code>:</p>

<pre style='background-color: #dddddd;'><code>posts = Post.where(:category_id =&gt; @category.id)</code></pre>

<p>You can then operate on the posts variable just like an <code style='background-color: #dddddd;'>Array</code> since it includes <code style='background-color: #dddddd;'>Enumerable</code>:</p>

<pre style='background-color: #dddddd;'><code>posts.first       # =&gt; #&lt;Post ...&gt;
posts.all         # =&gt; [#&lt;Post ...&gt;]

posts.each {|post| post.destroy }</code></pre>

<p>Other similar hash arguments like <code style='background-color: #dddddd;'>:limit</code>, <code style='background-color: #dddddd;'>:order</code>, and <code style='background-color: #dddddd;'>:select</code> are also methods now:</p>

<pre style='background-color: #dddddd;'><code>posts.limit(2).order(&quot;id DESC&quot;).select(&quot;body&quot;)</code></pre>

<p>Even <code style='background-color: #dddddd;'>:include</code>, which adds joins on, is now a method:</p>

<pre style='background-color: #dddddd;'><code>posts.include(:author).where(&quot;publshed NOT NULL&quot;)</code></pre>

<p>That should get you started converting your code. If you need more help, there are some great blog entries<em class='fn'>My favorite is http://m.onkey.org/2010/1/22/active-record-query-interface</em> and, of course the RDocs.<em class='fn'>Currently only accessible at http://api.rails.info/</em></p>

<h3 id='minor_prebooting_issues'><span class='maruku_section_number'>4.4. </span>Minor pre-booting issues</h3>

<p>If you&#8217;ve fixed the issues detailed here, you should be very close to booting. Depending on your application&#8217;s setup, though, you may need to do a few more things.</p>

<h4 id='delete_'><span class='maruku_section_number'>4.4.1. </span>Delete <code style='background-color: #dddddd;'>new_rails_defaults.rb</code></h4>

<p>As the Rails core team was moving towards Rails 3, an initializer was added to set a few of the configuration options to what they would be in Rails 3. This file makes transitioning to Rails 3 easier, and it&#8217;s a great tool to see if any part of your app would totally break on Rails 3. Most of the settings in there relate to JSON (changes to which could easily break your API), with one determining whether or not Active Record does partial saves (something most developers don&#8217;t need to worry about). Now that you&#8217;re actually on Rails 3, you should just delete this file.</p>

<h4 id='rack_configuration_is_required'><span class='maruku_section_number'>4.4.2. </span>Rack configuration is required</h4>

<p>If you regenerated your Rails application, you might have noticed that the Rails 3 generator gives you a <code style='background-color: #dddddd;'>config.ru</code> file in your application root; if you&#8217;re unfamiliar with how Rack<em class='fn'>http://rack.rubyforge.org/</em> works, <code style='background-color: #dddddd;'>config.ru</code> is basically a configuration file that tells Rack where to find its enpoints. Rails 3 is going seriously gung-ho on Rack, and as such, a <code style='background-color: #dddddd;'>config.ru</code> is now required in your application to tell Rack how to mount it. As noted earlier, the Rails 3 generator will spit one out for you, but if you&#8217;re doing a manual upgrade for some reason, then you&#8217;ll need to add one yourself.</p>

<p>Interesting note: Remember that <code style='background-color: #dddddd;'>YourApp::Application</code> class you created earlier in <code style='background-color: #dddddd;'>application.rb</code>? That&#8217;s your Rack endpoint; that&#8217;s why your <code style='background-color: #dddddd;'>config.ru</code> looks like this (or you should create one that looks like this if you&#8217;re doing all this manually):</p>

<pre style='background-color: #dddddd;'><code># This file is used by Rack-based servers to start the application.

require ::File.expand_path(&#39;../config/environment&#39;,  __FILE__)
run YourApp::Application.instance</code></pre>

<p>Neat, eh? That&#8217;s why I suggested you pick a meaningful name for that class: its touch runs quite deep in the request stack.</p>

<h3 id='booting_the_application'><span class='maruku_section_number'>4.5. </span>Booting the application</h3>

<p>Rails went the &#8220;Merb way&#8221; and has consolidated its many <code style='background-color: #dddddd;'>script/*</code> commands into the <code style='background-color: #dddddd;'>rails</code> binscript (or the <code style='background-color: #dddddd;'>script/rails</code> command). So things like <code style='background-color: #dddddd;'>generate</code>, <code style='background-color: #dddddd;'>server</code>, <code style='background-color: #dddddd;'>plugin</code>, etc. are now <code style='background-color: #dddddd;'>rails generate</code> and so on.</p>
<table><thead><tr><th>Was <code style='background-color: #dddddd;'>script/...</code></th><th>New command</th></tr></thead><tbody><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>server</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails server</code> (or <code style='background-color: #dddddd;'>rails s</code>)</td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>console</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails console</code> (or <code style='background-color: #dddddd;'>rails c</code>)</td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>generate</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails generate</code> (or <code style='background-color: #dddddd;'>rails g</code>)</td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>destroy</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails destroy</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>plugin</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails plugin</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>runner</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails runner</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>performance/benchmark</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails benchmark</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>performance/profiler</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails profiler</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>about</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rake about</code></td>
</tr><tr><td style='text-align: left;'><code style='background-color: #dddddd;'>dbconsole</code></td><td style='text-align: left;'><code style='background-color: #dddddd;'>rails dbconsole</code> (or <code style='background-color: #dddddd;'>rails db</code>)</td>
</tr></tbody></table>
<p>So, to start the application up, just run <code style='background-color: #dddddd;'>rails server</code> inside the application root (or, optionally, <code style='background-color: #dddddd;'>ruby script/rails server</code>). Once the server&#8217;s booted, navigate over to <code style='background-color: #dddddd;'>http://localhost:3000</code> and you should see a familiar friend:</p>

<p class='img'><img class='screenshot' src='http://media.tumblr.com/tumblr_kxctzqe4Su1qz4tvk.jpg' alt='Youre on board!' /></p>

<p>Click on &#8220;About your application&#8217;s environment&#8221; to see more information about the application; you should see the Rails version is &#8220;Rails 3.0.0&#8221;. Once you&#8217;ve verified it&#8217;s showing the right version, you&#8217;ll probably want to remove <code style='background-color: #dddddd;'>public/index.html</code>.</p>

<h3 id='its_booted_now_what'><span class='maruku_section_number'>4.6. </span>It&#8217;s booted! Now what&#8230;?</h3>

<p>Your application is booted, you can at least get a request into a controller, so now what? Well there are a couple of things to keep in mind&#8230;</p>

<h4 id='check_out_your_views'><span class='maruku_section_number'>4.6.1. </span>Check out your views</h4>

<p>You&#8217;ll want to give your views the once-over to make sure there&#8217;s no deprecated code (<code style='background-color: #dddddd;'>link_to_function</code> and friends being removed is probably going to be the most common), usage of removed/bad plugins, or usage of Ruby that&#8217;s not supported on 1.8.7 or later. Booting the application will catch many of these problems in models and controllers, but templates aren&#8217;t evaluated until they&#8217;re rendered, so something could still be lurking in there. Also keep in mind that all output strings (i.e., things you output using <code style='background-color: #dddddd;'>&lt;%=</code>) are escaped by default; this will cause problems for any helper or method that outputs HTML (especially in your tests; see Section 4.2 for how to fix it).</p>

<h4 id='deprecations_coming_soon'><span class='maruku_section_number'>4.6.2. </span>Deprecations coming soon</h4>

<p>There are a lot of things that are being deprecated in Rails 3. Many of them won&#8217;t break your application yet, but they will generate warnings you might not see in your logs. You can see a full list in the <strong>Deprecation Checklist</strong> section of the book, but there are a few that will bite you harder and probably sooner:</p>

<ul>
<li><strong><code style='background-color: #dddddd;'>allow_concurrency</code> is no longer needed</strong> Since Rails is Enterprise Thread Safe&#8482; now, you no longer need this setting.</li>

<li><strong>Requiring <code style='background-color: #dddddd;'>activerecord</code>/<code style='background-color: #dddddd;'>activesupport</code></strong> People could never remember whether it was <code style='background-color: #dddddd;'>active_record</code> or <code style='background-color: #dddddd;'>activerecord</code>, so the Rails team made it so that both will work. Starting very soon, though, you will be required to use the underscored form (e.g., <code style='background-color: #dddddd;'>active_record</code>).</li>

<li><strong><code style='background-color: #dddddd;'>filter_parameter_logging</code> API is changing</strong> The <code style='background-color: #dddddd;'>filter_parameter_logging</code> lets you set which parameter names to filter out of logs (e.g., don&#8217;t log your users passwords). This feature is now available by setting them up in <code style='background-color: #dddddd;'>application.rb</code> like this: <code style='background-color: #dddddd;'>config.filter_parameters &lt;&lt; :password</code></li>

<li><strong>Active Record&#8217;s errors API is different</strong> If you&#8217;re used to using <code style='background-color: #dddddd;'>errors.on_base</code> or <code style='background-color: #dddddd;'>errors.add_to_base</code>, then you&#8217;ll need to learn the new API (check the deprecations checklist).</li>
</ul>

<h2 id='improving_your_application_with_rails_3'><span class='maruku_section_number'>5. </span>Improving your application with Rails 3</h2>

<p>A lot of the refactoring and new few features in Rails can contribute to improving your codebase significantly if you take advantage of them. In this section, we&#8217;ll take a look at some of those features and changes and how to put them to use in your code today.</p>

<h3 id='cleaning_up_controllers'><span class='maruku_section_number'>5.1. </span>Cleaning up controllers</h3>

<p>Though the internals were torn apart, refactored, and greatly improved, the public API for controllers didn&#8217;t change a whole lot in the move to Rails 3. Even so, there were a couple of new features that can help you clean those controllers up.</p>

<h4 id='responders'><span class='maruku_section_number'>5.1.1. </span>Responders</h4>

<p>If you&#8217;ve got a lot of RESTful controllers chock full of methods that look like this:</p>

<pre style='background-color: #dddddd;'><code>def create
  @user = User.new(params[:user])

  respond_to do |format|
    if @user.save
      flash[:notice] = &#39;User was successfully created.&#39;
      format.html { redirect_to(@user) }
      format.xml  { render :xml =&gt; @user, :status =&gt; :created, :location =&gt; @user }
    else
      format.html { render :action =&gt; &quot;new&quot; }
      format.xml  { render :xml =&gt; @user.errors, :status =&gt; :unprocessable_entity }
    end
  end
end</code></pre>

<p>&#8230;then you&#8217;ll really appreciate the new <code style='background-color: #dddddd;'>Responder</code> feature of Action Controller. It can take all the logic in these boilerplate REST methods and wrap it into something that looks like this:</p>

<pre style='background-color: #dddddd;'><code>def create
  @user = User.new(params[:user])
  
  flash[:notice] = &quot;User was successfully created.&quot; if @user.save
  
  respond_with @user
end</code></pre>

<p>Essentially, it takes all the conventional REST logic and wraps it up in a nice little method <code style='background-color: #dddddd;'>respond_with</code>. It works with all the standard REST methods: <code style='background-color: #dddddd;'>index</code>, <code style='background-color: #dddddd;'>new</code>, <code style='background-color: #dddddd;'>create</code>, <code style='background-color: #dddddd;'>edit</code>, <code style='background-color: #dddddd;'>update</code>, and <code style='background-color: #dddddd;'>destroy</code>. You&#8217;re required to also tell the controller which formats to respond with like this:</p>

<pre style='background-color: #dddddd;'><code>class UsersController
  respond_to :html, :xml
  
  # Your REST methods here...
end</code></pre>

<p>The <code style='background-color: #dddddd;'>respond_to</code> method will accept any format you&#8217;ve defined a formatter for (defaults are <code style='background-color: #dddddd;'>:html</code>, <code style='background-color: #dddddd;'>:xml</code>, and <code style='background-color: #dddddd;'>:json</code>). Using this mechanism, you can cut about 50% of the code out of most RESTful controllers without sacrificing any of the control you&#8217;d have (unlike some of the plugins, which make you sacrifice some control over the logic flow). To override any of the default behavior, simply provide a block to the <code style='background-color: #dddddd;'>respond_with</code> call and add your overriding behavior. For example, let&#8217;s say you wanted to change the behavior when a user requests HTML:</p>

<pre style='background-color: #dddddd;'><code>def create
  @user = User.new(params[:user])

  flash[:notice] = &quot;User was successfully created.&quot; if @user.save

  respond_with(@user) do |format|
    format.html { redirect_to root_path }
  end
end</code></pre>

<p>You can also use this method with nested resources by simply providing the nesting as the argument list to <code style='background-color: #dddddd;'>respond_with</code> (e.g., <code style='background-color: #dddddd;'>respond_with(@account, @user)</code>).</p>

<h4 id='cleaner_flash_messages'><span class='maruku_section_number'>5.1.2. </span>Cleaner flash messages</h4>

<p>The Rails flash facility is a great way to pass simple objects or messages between requests, but adding an extra line of code just to stick a status message in the session gets annoying and verbose really quick. Rails 3 adds the nice ability to be able to put messages in conventional flash keys (<code style='background-color: #dddddd;'>:alert</code> and <code style='background-color: #dddddd;'>:notice</code>) right in <code style='background-color: #dddddd;'>redirect_to</code> calls:</p>

<pre style='background-color: #dddddd;'><code>format.html { redirect_to(@user, :notice =&gt; &#39;User was successfully created.&#39;) }</code></pre>

<p>This line of code will place <code style='background-color: #dddddd;'>&quot;User was successfully created.&quot;</code> in <code style='background-color: #dddddd;'>flash[:notice]</code>. You can do the same with <code style='background-color: #dddddd;'>:alert</code>:</p>

<pre style='background-color: #dddddd;'><code>format.html { render :action =&gt; &quot;new&quot;, :alert =&gt; &#39;There was a problem creating that post!&#39; }</code></pre>

<p>This shortcut doesn&#8217;t affect the usage of the <code style='background-color: #dddddd;'>flash</code> hash at all; it just adds some nice syntactic sugar on top.</p>

<h3 id='creating_improved_views'><span class='maruku_section_number'>5.2. </span>Creating improved views</h3>

<p>Action View is another component that got a significant internal refactoring, but it also received a bit of public API attention.</p>

<h4 id='making_your_views_safer'><span class='maruku_section_number'>5.2.1. </span>Making your views safer</h4>

<p>In Rails 3, all output strings in views are automatically escaped; so rather than calling <code style='background-color: #dddddd;'>h()</code> on a string (e.g., <code style='background-color: #dddddd;'>h(&quot;my unsafe string!&quot;)</code>), it is automatically escaped. This change means that if you have a helper or model method that returns HTML markup, it will spit the markup out as escaped HTML entities rather than HTML markup unless you tell Rails to make it a raw string. You can do this in one of three ways. The first is to use the new <code style='background-color: #dddddd;'>raw</code> method like you would have previously used <code style='background-color: #dddddd;'>h</code>:</p>

<pre style='background-color: #dddddd;'><code>raw(&quot;This is &lt;strong&gt;safe&lt;/strong&gt;!&quot;)</code></pre>

<p>This will copy the string into the response body without escaping. Strings also have a notion of being HTML safe, so you can mark it as such using the <code style='background-color: #dddddd;'>html_safe!</code> method:</p>

<pre style='background-color: #dddddd;'><code>&quot;this is &lt;em&gt;really&lt;/em&gt; safe!&quot;.html_safe!</code></pre>

<p>Rails will then know that string is safe no matter where you pass it. If it&#8217;s a helper that you need to allow to inject markup, then you can also use the <code style='background-color: #dddddd;'>safe_helper</code> method:</p>

<pre style='background-color: #dddddd;'><code>module ApplicationHelper
  def join_and_bold(arr)
    arr.map {|e| &quot;&lt;strong&gt;#{e}&lt;/strong&gt;&quot;}.join(&quot; &quot;)
  end
end

class MyController &lt; ActionController::Base
  safe_helper :join_and_bold
end</code></pre>

<p>Now any markup returned from the <code style='background-color: #dddddd;'>join_and_bold</code> method will be marked as raw. If you have code that already uses the <code style='background-color: #dddddd;'>h</code> method, don&#8217;t worry: it gives the same result so it won&#8217;t break anything.</p>

<h4 id='better_javascript_with_rails_3'><span class='maruku_section_number'>5.2.2. </span>Better JavaScript with Rails 3</h4>

<p>As mentioned previously, the JavaScript helpers in Rails 3 have been totally rebuilt to facilitate a framework agnostic approach. This change makes it dead easy to switch out your JavaScript frameworks without impacting your existing helper-driven code. Unfortunately, though, this rewrite means that existing code that uses the JavaScript helpers is out of luck.</p>

<blockquote>
<p><strong>PROTIP:</strong> You&#8217;re not <em>totally</em> out of luck. The Rails team have extracted the previous Prototype helpers into their own plugin available at http://github.com/rails/prototype_legacy_helper</p>
</blockquote>

<p>The new API for the pieces that still exist in their previous forms has changed. For example, this Rails 2.x code:</p>

<pre style='background-color: #dddddd;'><code>&lt;%= remote_form_for @user do |f| %&gt;
  &lt;!-- form here --&gt;
&lt;% end %&gt;</code></pre>

<p>Now looks like this in Rails 3:</p>

<pre style='background-color: #dddddd;'><code>&lt;%= remote_form_for(@user, :remote =&gt; true) do |f| %&gt;
  &lt;!-- form here --&gt;
&lt;% end %&gt;</code></pre>

<p>Essentially, AJAX forms use the same API as non-AJAX forms except for the extra <code style='background-color: #dddddd;'>:remote =&gt; true</code> parameter.</p>

<p>Not only is the API different, but their operation is, too. Previously, a helper like <code style='background-color: #dddddd;'>remote_form_for</code> would have emitted a <code style='background-color: #dddddd;'>&lt;form&gt;</code> tag with some JavaScript attached to it. This technique was not only bad practice by modern standards, it also tied it to one JavaScript framework unless you wanted to write a plugin to support another one, like jRails did with jQuery. This process was annoying and, again, wasn&#8217;t good practice.</p>

<p>So now these helpers emit HTML 5 markup with special data attributes which the framework drivers pick up on. For example, a simple <code style='background-color: #dddddd;'>form_for</code> with <code style='background-color: #dddddd;'>:remote =&gt; true</code> now emits this:</p>

<pre style='background-color: #dddddd;'><code>&lt;form action=&quot;/things&quot; class=&quot;new_thing&quot; data-remote=&quot;true&quot; id=&quot;new_thing&quot; method=&quot;post&quot;&gt;</code></pre>

<p>The <code style='background-color: #dddddd;'>data-remote</code> attribute tells the JavaScript driver that this form is an AJAX form, so it needs to attach extra behavior to it. You can also give this option to <code style='background-color: #dddddd;'>button_to</code> and the button will submit via AJAX.</p>

<p class='img'><img src='js.png' alt='Unobtrusive JavaScript' /></p>

<p>If you have calls to <code style='background-color: #dddddd;'>link_to_function</code> or the other helpers, you&#8217;d be better served by turning those into proper JavaScript powered links, writing custom JavaScript to power links sort of like the new Rails helpers do, or downloading the aforementioned plugin to carry you over.</p>

<h3 id='building_better_routes'><span class='maruku_section_number'>5.3. </span>Building better routes</h3>

<p>As you saw in Section 3.2.1, the Rails router DSL has changed significantly, and as part of the refactoring, the Rails core team has also added a number of new features. One of the best new router features that Rails 3 brings is optional segments; this means that you now have control over what route segments are not required to match the route (whereas before they were hardcoded names like <code style='background-color: #dddddd;'>id</code>). So, for example, let&#8217;s say you had an auction site with items that are categorized in categories and subcategories. You might have routes like this in Rails 2.x:</p>

<pre style='background-color: #dddddd;'><code>map.connect &#39;:category/items&#39;, :controller =&gt; &#39;items&#39;, :action =&gt; &#39;index&#39;
map.connect &#39;:category/items/:subcategory&#39;, :controller =&gt; &#39;items&#39;, :action =&gt; &#39;index&#39;</code></pre>

<p>In Rails 3, though, you can combine those into one route:</p>

<pre style='background-color: #dddddd;'><code>match &#39;:category/items(/:subcategory)&#39;, :to =&gt; &#39;items#index&#39;</code></pre>

<p>The two sets of routes are functionally equivalent; if <code style='background-color: #dddddd;'>:subcategory</code> is left out, the <code style='background-color: #dddddd;'>params</code> hash will simply not have the value. Another example of using these optional segments is the new default route in Rails 3. The default route(s) goes from:</p>

<pre style='background-color: #dddddd;'><code>map.connect &#39;:controller/:action/:id.:format&#39;
map.connect &#39;:controller/:action/:id&#39;</code></pre>

<p>&#8230;to the elegant and concise form that Rails 3 has:</p>

<pre style='background-color: #dddddd;'><code>match &#39;/:controller(/:action(/:id))&#39;</code></pre>

<p>In this route, the <code style='background-color: #dddddd;'>action</code> and <code style='background-color: #dddddd;'>id</code> segments are optional; if they are not given, a default value is supplied (e.g., in the case of <code style='background-color: #dddddd;'>action</code> it becomes <code style='background-color: #dddddd;'>index</code>) or is <code style='background-color: #dddddd;'>nil</code> (in the case of <code style='background-color: #dddddd;'>id</code>).</p>

<h4 id='routing_to_rack_applications'><span class='maruku_section_number'>5.3.1. </span>Routing to Rack applications</h4>

<p>The new router is yet another example of Rails commitment to Rack. My favorite new feature of the router is the ability to map routes to Rack endpoints other than your main application. So, for example, if you had an extra little Sinatra<em class='fn'>http://sinatrarb.com</em> application to handle simple API calls, you would have previously had to run the app in a separate process. This setup is nice for scalability, but it makes maintenance a pain and requires more infrastructure than necessary in most cases.</p>

<p>In Rails 3, though, you can route directly to these extra Rack applications through the router. Let&#8217;s say you have a Rack application class named <code style='background-color: #dddddd;'>ApiApplication</code>; if you wanted to route any requests to <code style='background-color: #dddddd;'>api/*</code> to that application, you would write a route like the following:</p>

<pre style='background-color: #dddddd;'><code>YourApp::Application.routes do
  match &quot;/api/:action&quot;, :to =&gt; ApiApplication
end</code></pre>

<p>You could then have a Sinatra or bare Rack app that would respond to that route; this is an extremely powerful tool for building service based applications that are easily scalable. Building it in this manner, you could easily bust the pieces of the application out on to other servers, making your application massively scalable.</p>

<h3 id='improving_your_model_logic'><span class='maruku_section_number'>5.4. </span>Improving your model logic</h3>

<p>Models also got a nice boost in features from their refactoring; the addition of Active Relation&#8217;s power opens up a wide world of possibilities.</p>

<h4 id='better_query_composition'><span class='maruku_section_number'>5.4.1. </span>Better query composition</h4>

<p>A common problem for developers who build apps that use a database is programmatically composing SQL queries intelligently. It&#8217;s easy to naively slap some SQL together, but as your schema and domain get more complex, this sorts of solutions fall down. Active Record&#8217;s old API made it fairly easy to compose queries, but if you needed to apply a lot of complex logic to them, it got sticky fast.</p>

<p>Fortunately the new API alleviates a lot of these problems. For example, let&#8217;s say you were working on a tumblog and had this <code style='background-color: #dddddd;'>Post</code> model:</p>

<pre style='background-color: #dddddd;'><code># Columns in posts:
#   id:           integer
#   user_id:      integer
#   content:      string
#   title:        string
#   body:         text
#   published_at: datetime
#   created_at:   datetime
#   updated_at:   datetime
class Post &lt; ActiveRecord::Base
  belongs_to :user
end</code></pre>

<p>Let&#8217;s you needed a filtering mechanism that allowed you to filter this tumblog&#8217;s posts based on what the content of post was (e.g., quote, picture, text, etc.), who wrote it, and whether it has any comments. First, you&#8217;d create a form that would pass something like the following to the controller parameters:</p>

<pre style='background-color: #dddddd;'><code>{
  :filter =&gt; {
    :content =&gt; &quot;quote&quot;,
    :comments =&gt; true,
    :user_id =&gt; &quot;1&quot;
  }
}</code></pre>

<p>The typical pattern in Rails 2.x would be to assemble a conditions hash based off of this then pass it back to the model to find what you need. The problem with that is that if you need to further refine the query at all, it was difficult. The addition of named scopes in 2.3 made this considerably easier, and since Active Relation works off the same ideas, it&#8217;s even easier to add this sort of logic all the way around.</p>

<p>So let&#8217;s add a <code style='background-color: #dddddd;'>filtered_relation</code> method to our model:</p>

<pre style='background-color: #dddddd;'><code>class Post &lt; ActiveRecord::Base
  belongs_to :user
  
  def filtered_relation(params)
    relation = scoped
  end
end</code></pre>

<p>So far, all our method does is return an empty <code style='background-color: #dddddd;'>Relation</code> to us, which will find any record in the table. Let&#8217;s go ahead and get our test suite going:</p>

<blockquote>
<p><strong>PROTIP:</strong> I&#8217;m going to use a factory method here, but you should probably use your favorite fixture replacement instead if it works with Rails 3.</p>
</blockquote>

<pre style='background-color: #dddddd;'><code>class PostTest &lt; ActiveSupport::TestCase
  setup do
    create_posts
  end

  test &quot;given a blank filter, returns all records&quot; do
    assert_equal Post.all, Post.filtered_relation({}).all
  end

  def teardown
    Post.delete_all
  end

  def create_posts
    valid_attributes = {
                        :body =&gt; &quot;Hello.&quot;, 
                        :title =&gt; &quot;Hi!&quot;, 
                        :content =&gt; &quot;text&quot;,
                        :user_id =&gt; 1,
                        :published_at =&gt; Time.now
                       }

    @base = Post.create(valid_attributes)
    @quote = Post.create(valid_attributes.merge(:content =&gt; &quot;quote&quot;))
    @number2 = Post.create(valid_attributes.merge(:user_id =&gt; 2))
    @old = Post.create(valid_attribtues.merge(:published_at =&gt; 1.year.ago))
  end
end</code></pre>

<p>So create a basic unit test suite, add a factory method, and then test that if we give it a blank filter, it doesn&#8217;t filter at all (i.e., we get all the records). The factory method I&#8217;ve made here just creates a few records and sticks them in instance variables. This setup isn&#8217;t ideal, but I don&#8217;t want to burden it with extra libraries and such. The test we&#8217;ve written will, of course, pass since we aren&#8217;t doing any filtering at all yet.</p>

<p>OK, so let&#8217;s write our first bit of filtering here. First, let&#8217;s add a test:</p>

<pre style='background-color: #dddddd;'><code>test &quot;given a content filter, only gives us the filtered records&quot; do
  assert_equal @quote, Post.filtered_relation(:content =&gt; &quot;quote&quot;).first
end</code></pre>

<p>Run <code style='background-color: #dddddd;'>rake</code> and the test should fail. Next, let&#8217;s edit our <code style='background-color: #dddddd;'>filtered_relation</code> method to accommodate filter methods; I&#8217;m taking a dynamic approach here:</p>

<pre style='background-color: #dddddd;'><code>def self.filtered_relation(params)
  relation = scoped

  params.each do |facet, value|
    relation = send(&quot;filter_by_#{facet}&quot;, value, relation)
  end

  relation
end</code></pre>

<p>Now the method takes the parameters <code style='background-color: #dddddd;'>Hash</code>, walks over each entry, and calls <code style='background-color: #dddddd;'>filter_by_[the key]</code>. So, if we pass it <code style='background-color: #dddddd;'>{{:content =&gt; &quot;quote&quot;}}</code>, it will call <code style='background-color: #dddddd;'>filter_by_content</code> and pass the value (<code style='background-color: #dddddd;'>&quot;quote&quot;</code>) and the current relation. Now we need to implement it:</p>

<pre style='background-color: #dddddd;'><code>def self.filter_by_content(value, relation)
  relation.where(:content =&gt; value)
end</code></pre>

<p>So we take the <code style='background-color: #dddddd;'>Relation</code> we&#8217;re given and call <code style='background-color: #dddddd;'>where</code>, adding a condition that <code style='background-color: #dddddd;'>content</code> needs to be the passed <code style='background-color: #dddddd;'>value</code>. Now let&#8217;s write tests for the other filters:</p>

<pre style='background-color: #dddddd;'><code>test &quot;given a date filter, only gives us the filtered records&quot; do
  assert_equal @old, Post.filtered_relation(:published_at =&gt; true).first
end

test &quot;given a comments count filter, only gives us the filtered records&quot; do
  assert_equal @base, Post.filtered_relation(:comments =&gt; true).first
end</code></pre>

<p>These are very similar to the previous test we wrote: given a filter set, give me the correct records. Now we need to implement those; we&#8217;ll start with the date filter:</p>

<pre style='background-color: #dddddd;'><code>def self.filter_by_published_at(value, relation)
  value ? relation.where(&quot;published_at &lt; ?&quot;, 1.month.ago) : relation
end</code></pre>

<p>So if we&#8217;re given a <code style='background-color: #dddddd;'>value</code> of <code style='background-color: #dddddd;'>true</code>, then filter the records based on whether or not the post is from more than a month ago; if it&#8217;s <code style='background-color: #dddddd;'>false</code> or <code style='background-color: #dddddd;'>nil</code>, then just give back the relation we received. If you <code style='background-color: #dddddd;'>rake</code>, that code&#8217;s test should pass, and you should still have on failing test case. Let&#8217;s implement the comments filter:</p>

<pre style='background-color: #dddddd;'><code>def self.filter_by_comments(value, relation)
  if value
    relation.preload(:comments).\
          select(&quot;posts.*, COUNT(comments.id) AS comment_count&quot;).\
          from(&quot;posts, comments&quot;).having(&quot;comment_count &gt; 0&quot;)
  else
    relation
  end
end</code></pre>

<p>Let&#8217;s break down this code a little. First, we check the value and act if it&#8217;s <code style='background-color: #dddddd;'>true</code>, return the relation untouched if it&#8217;s <code style='background-color: #dddddd;'>false</code>. Then we tell Active Record that when the query is executed, it should preload associated comments, then select our specific data (basically adding the comment count as an alias), from these tables (we have to add <code style='background-color: #dddddd;'>comments</code>), and give us records having these attributes (we use having here since we&#8217;re using an alias, which requires a postselect comparison). If you <code style='background-color: #dddddd;'>rake</code> now, all your tests should be passing.</p>

<p>This is great, but the real power in this approach is being able to chain even more things on to the returned relation. So, write some tests to make sure that works:</p>

<pre style='background-color: #dddddd;'><code>test &quot;given a content and comment filter, gives us filtered records&quot; do
  @base.update_attribute(:content, &quot;picture&quot;)
  assert_equal @base, Post.filtered_relation(:content =&gt; &quot;picture&quot;, 
                                             :comments =&gt; true).first
end

test &quot;given a date and comment filter, gives us filtered records&quot; do
  @base.update_attribute(:published_at, 2.years.ago)
  assert_equal @base, Post.filtered_relation(:published_at =&gt; true, 
                                             :comments =&gt; true).first
end

test &quot;given a date and content filter, gives us filtered records&quot; do
  @base.update_attribute(:published_at, 2.years.ago)
  @base.update_attribute(:content, &quot;picture&quot;)
  record = Post.filtered_relation(:published_at =&gt; true, 
                                  :content =&gt; &quot;picture&quot;).first
  assert_equal @base, record
end</code></pre>

<p>You could also write some tests that check for exclusion of records from the filtered set. So now you have some cool code to handle faceted filtering nicely. You could do things like this now:</p>

<pre style='background-color: #dddddd;'><code>posts = Post.filtered_relation(:comments =&gt; true).where(:user_id =&gt; 4)\
          .limit(3).order(&quot;id ASC&quot;)

posts.each do |post|
  # Do something here...
end</code></pre>

<p>This approach is much easier and cleaner than the previous <code style='background-color: #dddddd;'>Hash</code>-powered mess you would have to deal with. I now fully expect someone reading this to create a really great plugin to make this even nicer and easier (hint hint!).</p>

<h4 id='cleaning_up_your_validations'><span class='maruku_section_number'>5.4.2. </span>Cleaning up your validations</h4>

<p>Validations also received a nice little lift in Rails 3. The old API is still around, but there is also a variation on the old one:</p>

<pre style='background-color: #dddddd;'><code>validates :login, :presence =&gt; true, :length =&gt; {:minimum =&gt; 4},
          :uniqueness =&gt; true, :format =&gt; { :with =&gt; /[A-Za-z0-9]+/ }</code></pre>

<p>This new form is excellent since you can compress what would have previously been 4 lines of code into 1, making it dead simple to see all the validations related to a single attribute all in one place. The valid keys/value types for this form are:</p>

<ul>
<li><code style='background-color: #dddddd;'>:presence =&gt; true</code></li>

<li><code style='background-color: #dddddd;'>:uniqueness =&gt; true</code></li>

<li><code style='background-color: #dddddd;'>:numericality =&gt; true</code></li>

<li><code style='background-color: #dddddd;'>:length =&gt; { :minimum =&gt; 0, maximum =&gt; 2000 }</code></li>

<li><code style='background-color: #dddddd;'>:format =&gt; { :with =&gt; /.*/ }</code></li>

<li><code style='background-color: #dddddd;'>:inclusion =&gt; { :in =&gt; [1,2,3] }</code></li>

<li><code style='background-color: #dddddd;'>:exclusion =&gt; { :in =&gt; [1,2,3] }</code></li>

<li><code style='background-color: #dddddd;'>:acceptance =&gt; true</code></li>

<li><code style='background-color: #dddddd;'>:confirmation =&gt; true</code></li>
</ul>

<p>As I mentioned previously, you can still use the old API, but it makes sense to switch to this form since, when scanning your code, you&#8217;re rarely looking for what sort of validation it is rather than the attribute that&#8217;s being validated.</p>

<p>Another great new validation feature is the ability to have a custom validation class. It&#8217;s fairly common for Rails developers to develop their own validation methods that look something like this:</p>

<pre style='background-color: #dddddd;'><code>def validates_has_proper_category
  validates_each :category_id do |record, attr, value|
    unless record.user.category_ids.include?(value)
      record.errors.add attr, &#39;has bad category.&#39;
    end
  end
end</code></pre>

<p>These methods are really useful, especially if you use this validation in a lot of different classes, but they often add a bit of ugly code. Fortunately, in Rails a lot of that nastiness can go away. Those old methods should still work, but you could make them look like this instead:</p>

<pre style='background-color: #dddddd;'><code>class ProperCategoryValidator &lt; ActiveModel::EachValidator
  def validate_each(record, attribute, value)
    unless record.user.category_ids.include?(value)
      record.errors.add attribute, &#39;has bad category.&#39;
    end
  end
end</code></pre>

<p>Basically, create a class that inherits from <code style='background-color: #dddddd;'>ActiveModel::EachValidator</code> and implements a <code style='background-color: #dddddd;'>validate_each</code> method; inheriting from this class will make it available to all Active Record classes. Not only is the code a bit cleaner, it also makes these validations easily testable without much hassle, and you can also integrate them into the short form validations like this:</p>

<pre style='background-color: #dddddd;'><code>validate :category_id, :proper_category =&gt; true</code></pre>

<p>Note that the key name is taken from the class name (i.e., <code style='background-color: #dddddd;'>ProperCategoryValidator</code> becomes <code style='background-color: #dddddd;'>:proper_category</code>). A similar new feature is the ability to have validator classes that bundle validations into a single object. If you have a lot of classes that need some very complex validation logic, you can create a class like this:</p>

<pre style='background-color: #dddddd;'><code>class ReallyComplexValidator &lt; ActiveModel::Validator
  def validate(record)
    record.errors[:base] &lt;&lt; &quot;This check failed!&quot; unless thing(record)
    record.errors[:base] &lt;&lt; &quot;This failed!&quot; unless other(record)
    record.errors[:base] &lt;&lt; &quot;FAIL!&quot; unless fail(record)
  end

private
  def thing(record)
    # Complex validation here...
  end
  
  def other(record)
    # Complex validation here...
  end
  
  def fail(record)
    # Complex validation here...
  end
end</code></pre>

<p>The API is basically to inherit from <code style='background-color: #dddddd;'>ActiveModel::Validator</code> and implement a <code style='background-color: #dddddd;'>validate</code> method that takes a record as its only argument. Then in your model classes, use it like so:</p>

<pre style='background-color: #dddddd;'><code>class NewsPost &lt; ActiveRecord::Base
  validates_with ReallyComplexValidator
end</code></pre>

<p>This pattern is nice for wrapping up a lot of unruly validation code, but a more interesting variation on it will be building class factories based on parameters that build these validation classes. You can find a little more information these and other Active Model validation features in its API documentation.<em class='fn'>http://api.rails.info/classes/ActiveModel/Validator.html</em></p>

<h3 id='building_better_data_classes'><span class='maruku_section_number'>5.5. </span>Building better data classes</h3>

<p>When working with data classes other than database models (e.g., building objects based on API data for some remote service), building validation and attribute tracking logic can be a pain (especially if you end up doing it over and over again). Rails 3 extracts much of this sort of logic from Active Record into the new Active Model module, which you can include in your own data classes.</p>

<p>So, for example, let&#8217;s say you had a data class that represented a simple microblog (e.g., Twitter) message:</p>

<pre style='background-color: #dddddd;'><code>class Message
  include ActiveModel::Validations

  validates_presence_of :body, :user_id

  attr_accessor :body, :user_id, :posted_at
  def initialize(body, user_id)
    @body, @user_id = body, user_id
  end
end</code></pre>

<p>Now when you create these messages to be posted via some API library, you can validate their conformity to the API without a lot of extra hassle. A few API providers have already integrated this into their gems, making it simple to make sure you&#8217;re posting valid data.</p>

<p>Active Model also provides facilities for (de)serializing objects, tracking attributes&#8217; dirty status, observers, and more. You can read up on them on blogs<em class='fn'>http://yehudakatz.com/2010/01/10/activemodel-make-any-ruby-object-feel-like-activerecord/</em> and, of course, the API documentation.<em class='fn'>http://api.rails.info/</em></p>

<h2 id='case_studies'><span class='maruku_section_number'>6. </span>Case Studies</h2>

<h3 id='application_case_study_jamis_bucks_bucketwise'><span class='maruku_section_number'>6.1. </span>Application Case Study: Jamis Buck&#8217;s Bucketwise</h3>

<h3 id='plugin_case_study_'><span class='maruku_section_number'>6.2. </span>Plugin Case Study: <code style='background-color: #dddddd;'>restful_authentication</code></h3>

<h3 id='plugin_case_study'><span class='maruku_section_number'>6.3. </span>Plugin Case Study:</h3>

<h3 id='lessons_learned'><span class='maruku_section_number'>6.4. </span>Lessons learned</h3>

<h2 id='checksheet_the_upgrade_process'><span class='maruku_section_number'>7. </span>Checksheet: The Upgrade Process</h2>

<p>This checklist should give you a general guide to upgrade to Rails 3.</p>

<h3 id='first_steps'><span class='maruku_section_number'>7.1. </span>First Steps</h3>
<table class='overall-table'><thead><tr><th>&#10063;&#160;&#160;&#160;</th><th>&#160;</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Install <code style='background-color: #dddddd;'>rails_upgrade</code> plugin from <code style='background-color: #dddddd;'>http://github.com/rails/rails_upgrade</code></td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Run <code style='background-color: #dddddd;'>rake rails:upgrade:check</code> and note the results</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Run <code style='background-color: #dddddd;'>rake rails:upgrade:backup</code></td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Regenerate the application (i.e., <code style='background-color: #dddddd;'>rails ./</code>)</td>
</tr></tbody></table>
<h3 id='reconfiguration'><span class='maruku_section_number'>7.2. </span>Reconfiguration</h3>
<table class='overall-table'><thead><tr><th>&#10063;&#160;&#160;&#160;</th><th>&#160;</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Move <code style='background-color: #dddddd;'>Initializer</code> code from <code style='background-color: #dddddd;'>environment.rb</code> to <code style='background-color: #dddddd;'>application.rb</code></td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Convert routes to new API</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Create <code style='background-color: #dddddd;'>Gemfile</code></td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Move <code style='background-color: #dddddd;'>config.gem</code> calls to <code style='background-color: #dddddd;'>Gemfile</code> syntax</td>
</tr></tbody></table>
<h3 id='fix_code'><span class='maruku_section_number'>7.3. </span>Fix code</h3>
<table class='overall-table'><thead><tr><th>&#10063;&#160;&#160;&#160;</th><th>&#160;</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Remove old constants</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Convert mailers to new API</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Move to new Active Record API</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Check for invalid and deprecated code in views</td>
</tr></tbody></table>
<h3 id='booting'><span class='maruku_section_number'>7.4. </span>Booting</h3>
<table class='overall-table'><thead><tr><th>&#10063;&#160;&#160;&#160;</th><th>&#160;</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Run tests, fix deprecation and other errors</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Boot with <code style='background-color: #dddddd;'>rails server</code></td>
</tr></tbody></table>
<h2 id='checksheet_deprecations'><span class='maruku_section_number'>8. </span>Checksheet: Deprecations</h2>

<p>This check list contains nearly every deprecation in Rails 3. Many of them probably won&#8217;t apply to you, but most of them will probably bite you in one place or another.</p>

<h3 id='generalconfiguration'><span class='maruku_section_number'>8.1. </span>General/configuration</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>RAILS_ENV</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>Rails.env</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>RAILS_ROOT</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>Rails.root</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>RAILS_DEFAULT_LOGGER</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>Rails.logger</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Calling <code style='background-color: #dddddd;'>filter_parameter_logging</code> is no longer supported.</td><td style='text-align: right;'>Set/append to <code style='background-color: #dddddd;'>config.filter_parameters</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>AC::Dispatcher.before_dispatch</code> is deprecated.</td><td style='text-align: right;'>Please use <code style='background-color: #dddddd;'>ActionDispatch::Callbacks.before</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>AC::Dispatcher.to_prepare</code> is deprecated.</td><td style='text-align: right;'>Please use <code style='background-color: #dddddd;'>config.to_prepare</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Creating new <code style='background-color: #dddddd;'>AC::Dispatcher</code> objects is deprecated.</td><td style='text-align: right;'>Create/interact with the <code style='background-color: #dddddd;'>Rails::Application</code> object instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.action_controller.</code><br /><code style='background-color: #dddddd;'>consider_all_requests_local</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>Rails.application.</code><br /><code style='background-color: #dddddd;'>config.consider_all_requests_local</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.action_controller.</code><br /><code style='background-color: #dddddd;'>allow_concurrency</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>Rails.application.</code><br /><code style='background-color: #dddddd;'>config.allow_concurrency</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>benchmark(:level)</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>benchmark(&quot;message&quot;, :level =&gt; level)</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.view_path</code> / <code style='background-color: #dddddd;'>config.view_path=</code> are deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>paths.app.views</code> / <code style='background-color: #dddddd;'>paths.app.views=</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.routes_configuration_file</code> / <code style='background-color: #dddddd;'>config.routes_configuration_file=</code> are deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>paths.config.routes</code> / <code style='background-color: #dddddd;'>paths.config.routes=</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.routes_configuration_file</code> / <code style='background-color: #dddddd;'>config.routes_configuration_file=</code> are deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>paths.config.routes</code> / <code style='background-color: #dddddd;'>paths.config.routes=</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.database_configuration_file</code> / <code style='background-color: #dddddd;'>config.database_configuration_file=</code> have been deprecated.</td><td style='text-align: right;'>Do <code style='background-color: #dddddd;'>paths.config.</code><br /><code style='background-color: #dddddd;'>database</code>/<code style='background-color: #dddddd;'>paths.config.</code><br /><code style='background-color: #dddddd;'>database=</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.controller</code><br /><code style='background-color: #dddddd;'>_paths</code> / <code style='background-color: #dddddd;'>config.controller</code><br /><code style='background-color: #dddddd;'>_paths=</code> are deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>paths.app.</code><br /><code style='background-color: #dddddd;'>controllers</code> / <code style='background-color: #dddddd;'>paths.app.</code><br /><code style='background-color: #dddddd;'>controllers=</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>config.log_path</code> / <code style='background-color: #dddddd;'>config.log_path=</code> are deprecated.</td><td style='text-align: right;'>Do <code style='background-color: #dddddd;'>paths.log</code> / <code style='background-color: #dddddd;'>paths.log=</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>The <code style='background-color: #dddddd;'>gem</code> method in application templates deprecated the <code style='background-color: #dddddd;'>:env</code> key.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>:only</code></td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>The <code style='background-color: #dddddd;'>freeze!</code> method in application templates is deprecated.</td><td style='text-align: right;'>It&#8217;s no longer needed.</td>
</tr></tbody></table>
<h3 id='plugins'><span class='maruku_section_number'>8.2. </span>Plugins</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Putting Rake tasks in <code style='background-color: #dddddd;'>[path]/tasks</code> or <code style='background-color: #dddddd;'>[path]/rails/tasks</code> is no longer supported.</td><td style='text-align: right;'>Place them in <code style='background-color: #dddddd;'>[path]/lib/tasks</code>.</td>
</tr></tbody></table>
<h3 id='controllersdispatch'><span class='maruku_section_number'>8.3. </span>Controllers/dispatch</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Disabling sessions for a single controller has been deprecated.</td><td style='text-align: right;'>Sessions are lazy loaded, so don&#8217;t worry about them if you don&#8217;t use them.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>session.update</code> is no longer effective.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>session.replace</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>session.delete</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>session.clear</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>SessionHash#session_id</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.session_options[:id]</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>SessionHash#data</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>SessionHash#to_hash</code> instead.</td>
</tr></tbody></table>
<h3 id='models'><span class='maruku_section_number'>8.4. </span>Models</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>named_scope</code> is deprecated.</td><td style='text-align: right;'>Change to <code style='background-color: #dddddd;'>scope</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>Model.human_name</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>Model.model_name.human</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Adding callback methods named <code style='background-color: #dddddd;'>after_save</code>, <code style='background-color: #dddddd;'>after_create</code>, etc. is deprecated.</td><td style='text-align: right;'>Create a method then call <code style='background-color: #dddddd;'>after_save :method_name</code> (or whatever callback).</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>errors.on_base</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>errors[:base]</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>errors.add_to_base</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>errors[:base] &lt;&lt; error</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>errors.invalid?(attr)</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>errors[attr].any?</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>errors.each_full</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>errors.to_a.each</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Providing a block to <code style='background-color: #dddddd;'>composed_of</code> is deprecated.</td><td style='text-align: right;'>Provide a <code style='background-color: #dddddd;'>:converter</code> argument with a lambda/<code style='background-color: #dddddd;'>Proc</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>colorize_logging</code> has been moved.</td><td style='text-align: right;'>Change the calls to <code style='background-color: #dddddd;'>Rails::Subscriber.</code><br /><code style='background-color: #dddddd;'>colorize_logging</code>.</td>
</tr></tbody></table>
<h3 id='views'><span class='maruku_section_number'>8.5. </span>Views</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>error_message_on</code> takes an option hash instead of separate arguments.</td><td style='text-align: right;'>Pass an options hash with <code style='background-color: #dddddd;'>:prepend_text</code>, <code style='background-color: #dddddd;'>:append_text</code>, and <code style='background-color: #dddddd;'>:css_class</code> keys.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>number_with_delimiter</code> takes an options hash instead of arguments.</td><td style='text-align: right;'>Pass a hash with <code style='background-color: #dddddd;'>:delimiter</code> and <code style='background-color: #dddddd;'>:precision</code> keys.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>number_with_precision</code> takes an options hash rather than an argument.</td><td style='text-align: right;'>Pass an options hash with a <code style='background-color: #dddddd;'>:precision</code> key.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>number_to_human_size</code> takes an options hash rather than an argument.</td><td style='text-align: right;'>Pass an options hash with a <code style='background-color: #dddddd;'>:precision</code> key.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>truncate</code> takes an options hash instead of arguments.</td><td style='text-align: right;'>Pass a hash with <code style='background-color: #dddddd;'>:length</code> and <code style='background-color: #dddddd;'>:omission</code> keys.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>:popup</code> is deprecated on <code style='background-color: #dddddd;'>link_to</code>.</td><td style='text-align: right;'>(No fix)</td>
</tr></tbody></table>
<h3 id='testing'><span class='maruku_section_number'>8.6. </span>Testing</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>model_instance.assert_valid</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>assert model_instance.valid?</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.template</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>controller.template</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.session</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.session</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.assigns</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>controller.assigns</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.layout</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>controller.template.layout</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.redirected_to</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>response.redirect_url</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.redirect_url_match?</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>assert_match</code> and <code style='background-color: #dddddd;'>response.redirect_url</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.rendered</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>template.rendered</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.flash</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.flash</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.has_flash?</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.flash.any?</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.has_flash_with_contents?</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.flash.any?</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.has_flash_object?</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.flash[name]</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.has_session_object?</code> has been deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>request.session[name]</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.template_objects</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>template.assigns</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.has_template_object?</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>tempate.assigns[name].nil?</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>response.binary_content</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>response.body</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>test/mocks</code> won&#8217;t be added to load paths automatically.</td><td style='text-align: right;'>Add it yourself.</td>
</tr></tbody></table>
<h3 id='mailers'><span class='maruku_section_number'>8.7. </span>Mailers</h3>
<table class='deprecation-table'><thead><tr><th>&#160;</th><th>Deprecation</th><th>How to fix it</th></tr></thead><tbody><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>default_charset</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>default :charset =&gt; value</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>default_content_type</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>default :content_type =&gt; value</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>default_mime_version</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>default :mime_version =&gt; value</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>default_implicit_parts_order</code> is deprecated.</td><td style='text-align: right;'>Change it to <code style='background-color: #dddddd;'>default :implicit_parts_order =&gt; value</code>.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Calling <code style='background-color: #dddddd;'>deliver</code> on the class instance</td><td style='text-align: right;'>Call <code style='background-color: #dddddd;'>deliver</code> on the mail object instance.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Setting <code style='background-color: #dddddd;'>template_root=</code></td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>prepend_view_path</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Delivering mail with <code style='background-color: #dddddd;'>deliver_*</code></td><td style='text-align: right;'>Use the <code style='background-color: #dddddd;'>deliver</code> on the mailer instance instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Creating a mail message with <code style='background-color: #dddddd;'>create_*</code></td><td style='text-align: right;'>Call the mailer method and call <code style='background-color: #dddddd;'>to_s</code> on the returned mail object</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Setting <code style='background-color: #dddddd;'>:body</code> variables</td><td style='text-align: right;'>Use normal instance variables (like a controller)</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>render_message</code> on <code style='background-color: #dddddd;'>Message</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>render</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>set_content_type</code> on <code style='background-color: #dddddd;'>Message</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>content_type</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>transfer_encoding</code> on <code style='background-color: #dddddd;'>Message</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>content_transfer_encoding</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'>Setting <code style='background-color: #dddddd;'>transfer_encoding=</code> on <code style='background-color: #dddddd;'>Message</code> is deprecated.</td><td style='text-align: right;'>Set <code style='background-color: #dddddd;'>content_transfer_encoding=</code> instead.</td>
</tr><tr><td style='text-align: left;'>&#10063;&#160;&#160;&#160;</td><td style='text-align: left;'><code style='background-color: #dddddd;'>original_filename</code> on <code style='background-color: #dddddd;'>Message</code> is deprecated.</td><td style='text-align: right;'>Use <code style='background-color: #dddddd;'>filename</code> instead.</td>
</tr></tbody></table></body></html>
